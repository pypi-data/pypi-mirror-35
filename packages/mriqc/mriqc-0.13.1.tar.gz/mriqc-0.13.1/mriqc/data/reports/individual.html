<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="MRIQC" />
<title>MRIQC: individual {{ modality }}
report</title>
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
<style type="text/css">
body {
  font-family: helvetica;
  padding: 50px 10px 10px;
}

div.warning p.admonition-title, .code .error {
  color: red ;
  font-weight: bold ;
}

span.problematic {
  color: red;
  font-weight: bold ;
}

p.label {
  white-space: nowrap }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

div.embeded-report {
  width: 100%;
  page-break-before:always;
  padding-top: 20px;
}

div.embeded-report svg { width: 100%; }

span.qa-fail {
    color: white;
    font-weight: bold;
    background-color: #FF6347;
}

span.qa-pass {
    color: white;
    font-weight: bold;
    background-color: #32CD32;
}

h1 { margin-top: 30px; }
h2 { margin-top: 20px; }

div#accordionOther {
    margin: 0 20px;
}

.add-padding {
    padding-top: 15px;
}

</style>
</head>
<body>
<div class="document">

<nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light">
<div class="collapse navbar-collapse">
    <ul class="navbar-nav">
      <li class="nav-item"><a class="nav-link" href="#summary">Summary</a></li>
      <li class="nav-item"><a class="nav-link" href="#visuals">Visual reports</a></li>
      <li class="nav-item"><a class="nav-link" href="#other">Other</a></li>
      {% if provenance %}
      <li class="nav-item"><a class="nav-link" href="#feedback">Rate image</a></li>
      {% endif %}
    </ul>
</div>
</nav>

<noscript>
    <h1 class="text-danger"> The navigation menu uses Javascript. Without it this report might not work as expected </h1>
</noscript>

<h1>MRIQC: individual {{ modality }}
report</h1>

<h2 id="summary">Summary</h2>
<ul class="simple">
<li>Subject ID: {{ sub_id }}.</li>
{% if pred_qa is not none %}
<li>MRIQC predicted QA:
{% if pred_qa > 0 %}<span class="qa-fail">Exclude</span>
{% else %}<span class="qa-pass">Pass</span>
{% endif %}
</li>
{% endif %}
<li>Date and time: {{ timestamp }}.</li>
<li>MRIQC version: {{ version }}.</li>
{% if workflow_details %}
<li>Workflow details:
  <ul class="sub-simple">
  {% for detail in workflow_details %}
  <li>{{ detail }}</li>
  {% endfor %}
  </ul>
</li>
{% endif %}
</ul>

<h2 id="visuals">Visual reports</h2>
{% for title, svg in svg_files %}
<div class="embeded-report">
  <h3>{{ title }}</h3>
{{ svg }}
</div>
{% endfor %}

<h2 id="other">Other</h2>
<div class="accordion" id="accordionOther">
  <div class="card">
    <div class="card-header" id="headingOne">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
          Extracted Image Quality Metrics (IQMs)
        </button>
      </h5>
    </div>

    <div id="collapseOne" class="collapse" aria-labelledby="headingOne" data-parent="#accordionOther">
      <div class="card-body metadata-table">
      {{ imparams }}
      </div>
    </div>
  </div>
{% if metadata %}
  <div class="card">
    <div class="card-header" id="headingTwo">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
          Metadata
        </button>
      </h5>
    </div>
    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo" data-parent="#accordionOther">
      <div class="card-body metadata-table">
      {{ metadata }}
      </div>
    </div>
  </div>
{% endif %}
{% if provenance %}
  <div class="card">
    <div class="card-header" id="headingThree">
      <h5 class="mb-0">
        <button class="btn btn-link collapsed" type="button" data-toggle="collapse" data-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
          Provenance information
        </button>
      </h5>
    </div>
    <div id="collapseThree" class="collapse" aria-labelledby="headingThree" data-parent="#accordionOther">
      <div class="card-body provenance-table">
      {{ provenance }}
      </div>
    </div>
  </div>
</div>
{% endif %}

{% if provenance %}
<h2 id="feedback">Rate Image</h2>
<div id="submitResAlert" role="alert" class="invisible alert alert-success">Submitted</div>
<div class="container">
<form action="javascript:sendRating()">
    <div class="form-group">
        <input id="ratingField" type="hidden" required>
        <div class="radio"><label><input type="radio" name="inlineRadio" id="inlineRating0" value="0" required> Invalid</label></div>
        <div class="radio"><label><input type="radio" name="inlineRadio" id="inlineRating1" value="1"> Exclude</label></div>
        <div class="radio"><label><input type="radio" name="inlineRadio" id="inlineRating2" value="2"> Usable</label></div>
        <div class="radio"><label><input type="radio" name="inlineRadio" id="inlineRating3" value="3"> Good</label></div>
        Name: <br><input id="ratingName" type="text" class="form-control"><br>
        Comments: <br><textarea rows="4" id="ratingComment" type="text" class="form-control"></textarea><br>
        <input type="submit" value="Submit">
    </div>
</form>
<div class="d-none add-padding" id="allRatingsDiv">
    <h5 class="mb-0 add-padding">Previous ratings found in MRIQC's WebAPI</h5>
    <table class="table table-striped">
    <thead>
        <tr>
            <th>Rating</th>
            <th>Count</th>
        </tr>
    <tbody>
        <tr>
            <td>Invalid</td>
            <td id="allRatings0"></td>
        </tr>
        <tr>
            <td>Exclude</td>
            <td id="allRatings1"></td>
        </tr>
        <tr>
            <td>Usable</td>
            <td id="allRatings2"></td>
        </tr>
        <tr>
            <td>Good</td>
            <td id="allRatings3"></td>
        </tr>
    </tbody>
    </thead>
    </table>
</div>
</div>
<script type="text/javascript">
var sentOnce = false;

function setAllRatings(allRatings) {
    allRatings['_items'].sort(function(a, b) {
        if(a['_id'] < b['_id']) return -1;
        if(a['_id'] > b['_id']) return 1;
        return 0;
    });
    console.log(allRatings);
    var arrayLength = allRatings['_items'].length;
    for (var i = 0; i < arrayLength; i++) {
        var elid = "allRatings" + allRatings['_items'][i]['_id'];
        document.getElementById(elid).textContent = allRatings['_items'][i]['count'];
    }
    document.getElementById("allRatingsDiv").classList.remove("d-none");
};

function sendRating() {
    var allRatings;
    var rating;
    var radios = document.getElementsByName("inlineRadio");
    for (var i = 0; i < radios.length; i++) {
        if (radios[i].checked) {
            rating = radios[i].value;
            break;
        }
    }
    var md5sum = "{{ md5sum }}";
    var name = document.getElementById("ratingName").value;
    var comment = document.getElementById("ratingComment").value;
    var params = {'rating': rating, 'md5sum': md5sum, 'name': name, 'comment': comment};

    var ratingReq = new XMLHttpRequest();
    var allRatingsReq = new XMLHttpRequest();
    var aggParam = '{\"$value\":\"' + md5sum + '\"}';
    allRatingsReq.open("GET", "{{ webapi_url }}/rating_counts?aggregate=" + aggParam);
    allRatingsReq.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    allRatingsReq.setRequestHeader("Authorization", "8sSYVI0XjFqacEMZ8wF4");
    ratingReq.open("POST", "{{ webapi_url }}/rating");
    ratingReq.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    ratingReq.setRequestHeader("Authorization", "8sSYVI0XjFqacEMZ8wF4");
    ratingReq.onload = function () {
        status = ratingReq.status;
        if (status === "201") {
            sentOnce = true;
            allRatingsReq.send();
            setAlert();
        }
    };
    allRatingsReq.onload = function () {
        console.log(allRatingsReq.response);
        allRatings = JSON.parse(allRatingsReq.response);
        setAllRatings(allRatings);
    };
    ratingReq.send(JSON.stringify(params));
};

function setAlert() {
    alertElem = document.getElementById("submitResAlert");
    alertElem.classList.remove("invisible");
    alertElem.classList.add("visible");
};

</script>
{% endif %}

<p>For details on the IQMs (image quality metrics) and further information on
the enclosed plots, please read the
<a class="reference external" href="http://mriqc.readthedocs.io/en/stable/measures.html">documentation</a>.</p>
</body>
</html>
