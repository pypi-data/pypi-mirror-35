/**
 * Name         : Martor v1.2.8
 * Created by   : Agus Makmun (Summon Agus)
 * Release date : 20-Aug-2018
 * License      : GNU GENERAL PUBLIC LICENSE Version 3, 29 June 2007
 * Repository   : https://github.com/agusmakmun/django-markdown-editor
**/

!function(e){e||(e=django.jQuery),e.fn.martor=function(){var n=e(this),o=e(".main-martor");n.trigger("martor.init");var t=function(e){var n=null,o=0;if(document.cookie&&""!==document.cookie)for(var t=document.cookie.split(";");o<t.length;o++){var a=jQuery.trim(t[o]);if(a.substring(0,e.length+1)===e+"="){n=decodeURIComponent(a.substring(e.length+1));break}}return n};o.each(function(n,o){var a=e(o).data("field-name"),i=e("#id_"+a),r="martor-"+a,s=ace.edit(r),l=JSON.parse(i.data("enable-configs").replace(/'/g,'"'));s.setTheme("ace/theme/github"),s.getSession().setMode("ace/mode/markdown"),s.getSession().setUseWrapMode(!0),s.$blockScrolling=1/0,s.renderer.setScrollMargin(10,10),s.setAutoScrollEditorIntoView(!0),s.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0,enableMultiselect:!1}),"true"==l.living&&e(o).addClass("enable-living");var m={getCompletions:function(e,n,o,t,a){var i=emojis,r=e.getSession().getTokenAt(o.row,o.column.count).value.split(/\s+/);":"==r[r.length-1][0]&&a(null,i.map(function(e){return{caption:e,value:e.replace(":","")+" ",meta:"emoji"}}))}},c={getCompletions:function(n,o,a,r,s){var l=n.getSession().getTokenAt(a.row,a.column.count).value.split(/\s+/),m=l[l.length-1];"@"==m[0]&&"["==m[1]&&(username=m.replace(/([\@\[/\]/])/g,""),e.ajax({url:i.data("search-users-url"),data:{username:username,csrfmiddlewaretoken:t("csrftoken")},success:function(e){if(200==e.status){for(var n=[],o=0;o<e.data.length;o++)n.push(e.data[o].username);s(null,n.map(function(e){return{caption:e,value:e,meta:"username"}}))}}}))}};"true"===l.mention?s.completers=[m,c]:s.completers=[m],i.attr({style:"display:none"}),e(o).find(".martor-toolbar").find(".markdown-selector").attr({"data-field-name":a}),e(o).find(".upload-progress").attr({"data-field-name":a}),e(o).find(".modal-help-guide").attr({"data-field-name":a}),e(o).find(".modal-emoji").attr({"data-field-name":a}),s.on("change",function(e){var n=s.getValue();i.val(n)}),e("#"+r).resizable({direction:"bottom",stop:function(){s.resize()}});var d=e(".tab.segment[data-tab=preview-tab-"+a+"]"),u=e(".item[data-tab=preview-tab-"+a+"]");refreshPreview=function(){var n=s.getValue(),o=new FormData;o.append("content",n),o.append("csrfmiddlewaretoken",t("csrftoken")),e.ajax({url:i.data("markdownfy-url"),type:"POST",data:o,processData:!1,contentType:!1,success:function(n){n?(d.html(n),e("pre").each(function(e,n){hljs.highlightBlock(n)})):d.html("<p>Nothing to preview</p>")},error:function(e){console.log("error",e)}})},u.click(function(){e(this).closest(".tab-martor-menu").find(".martor-toolbar").hide(),refreshPreview()}),"true"===l.living&&s.on("change",refreshPreview),e(".item[data-tab=editor-tab-"+a+"]").click(function(){e(this).closest(".tab-martor-menu").find(".martor-toolbar").show()});var g=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," **** "),e.selection.moveTo(o.row,o.column+3)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"**"+a+"**"),n.end.column+=4,e.selection.setSelectionRange(n)}},f=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," __ "),e.selection.moveTo(o.row,o.column+2)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"_"+a+"_"),n.end.column+=2,e.selection.setSelectionRange(n)}},v=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n----------\n\n"),e.selection.moveTo(o.row+4,o.column+10)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n----------\n\n"+a),e.selection.moveTo(n.end.row+4,n.end.column+10)}},p=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n# "),e.selection.moveTo(o.row+2,o.column+2)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n# "+a+"\n"),e.selection.moveTo(n.end.row+2,n.end.column+2)}},w=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n## "),e.selection.moveTo(o.row+2,o.column+3)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n## "+a+"\n"),e.selection.moveTo(n.end.row+2,n.end.column+3)}},k=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n### "),e.selection.moveTo(o.row+2,o.column+4)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n### "+a+"\n"),e.selection.moveTo(n.end.row+2,n.end.column+4)}},C=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n```\n\n```\n"),e.selection.moveTo(o.row+3,o.column)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n```\n"+a+"\n```\n"),e.selection.moveTo(n.end.row+3,n.end.column+3)}},h=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," `` "),e.selection.moveTo(o.row,o.column+2)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"`"+a+"`"),n.end.column+=2,e.selection.setSelectionRange(n)}},y=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n> \n"),e.selection.moveTo(o.row+2,o.column+2)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n> "+a+"\n"),e.selection.moveTo(n.end.row+2,n.end.column+2)}},T=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n* "),e.selection.moveTo(o.row+2,o.column+2)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n* "+a),e.selection.moveTo(n.end.row+2,n.end.column+2)}},S=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o,"\n\n1. "),e.selection.moveTo(o.row+2,o.column+3)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"\n\n1. "+a),e.selection.moveTo(n.end.row+2,n.end.column+3)}},R=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," [](http://) "),e.selection.moveTo(o.row,o.column+2)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"["+a+"](http://) "),e.selection.moveTo(n.end.row,n.end.column+10)}},b=function(e,n){var o=e.getSelectionRange();if(void 0===n)if(e.selection.isEmpty()){var t=e.getCursorPosition();e.session.insert(t," ![](http://) "),e.selection.moveTo(t.row,t.column+3)}else{var a=e.getSelectionRange(),i=e.session.getTextRange(a);e.session.replace(a,"!["+i+"](http://) "),e.selection.moveTo(o.end.row,o.end.column+11)}else{t=e.getCursorPosition();e.session.insert(t,"!["+n.name+"]("+n.link+") "),e.selection.moveTo(t.row,t.column+n.name.length+2)}},x=function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," @[]"),e.selection.moveTo(o.row,o.column+3)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"@["+a+"]"),e.selection.moveTo(n.end.row,n.end.column+3)}},O=function(n){var o=e("#"+r).closest("form").get(0),a=n.container.id.replace("martor-",""),s=new FormData(o);return s.append("csrfmiddlewaretoken",t("csrftoken")),e.ajax({url:i.data("upload-url"),type:"POST",data:s,async:!0,cache:!1,contentType:!1,enctype:"multipart/form-data",processData:!1,beforeSend:function(){console.log("Uploading..."),e(".upload-progress[data-field-name="+a+"]").show()},success:function(o){e(".upload-progress[data-field-name="+a+"]").hide(),200==o.status?(console.log(o),b(n=n,imageData={name:o.name,link:o.link})):403==o.status?alert(o.data.error):console.log(o)},error:function(n){console.log("error",n),e(".upload-progress[data-field-name="+a+"]").hide()}}),!1};s.commands.addCommand({name:"markdownToBold",bindKey:{win:"Ctrl-B",mac:"Command-B"},exec:function(e){g(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToItalic",bindKey:{win:"Ctrl-I",mac:"Command-I"},exec:function(e){f(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToUnderscores",bindKey:{win:"Ctrl-Shift-U",mac:"Command-Option-U"},exec:function(e){!function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," ++++ "),e.selection.moveTo(o.row,o.column+3)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"++"+a+"++"),n.end.column+=4,e.selection.setSelectionRange(n)}}(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToStrikethrough",bindKey:{win:"Ctrl-Shift-S",mac:"Command-Option-S"},exec:function(e){!function(e){var n=e.getSelectionRange();if(e.selection.isEmpty()){var o=e.getCursorPosition();e.session.insert(o," ~~~~ "),e.selection.moveTo(o.row,o.column+3)}else{var t=e.getSelectionRange(),a=e.session.getTextRange(t);e.session.replace(t,"~~"+a+"~~"),n.end.column+=4,e.selection.setSelectionRange(n)}}(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToHorizontal",bindKey:{win:"Ctrl-H",mac:"Command-H"},exec:function(e){v(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToH1",bindKey:{win:"Ctrl-Alt-1",mac:"Command-Option-1"},exec:function(e){p(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToH2",bindKey:{win:"Ctrl-Alt-2",mac:"Command-Option-3"},exec:function(e){w(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToH3",bindKey:{win:"Ctrl-Alt-3",mac:"Command-Option-3"},exec:function(e){k(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToPre",bindKey:{win:"Ctrl-Alt-P",mac:"Command-Option-P"},exec:function(e){C(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToCode",bindKey:{win:"Ctrl-Alt-C",mac:"Command-Option-C"},exec:function(e){h(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToBlockQuote",bindKey:{win:"Ctrl-Q",mac:"Command-Q"},exec:function(e){y(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToUnorderedList",bindKey:{win:"Ctrl-U",mac:"Command-U"},exec:function(e){T(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToOrderedList",bindKey:{win:"Ctrl-Shift+O",mac:"Command-Option-O"},exec:function(e){S(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToLink",bindKey:{win:"Ctrl-L",mac:"Command-L"},exec:function(e){R(e)},readOnly:!0}),s.commands.addCommand({name:"markdownToImageLink",bindKey:{win:"Ctrl-Shift-I",mac:"Command-Option-I"},exec:function(e){b(e)},readOnly:!0}),"true"===l.mention&&s.commands.addCommand({name:"markdownToMention",bindKey:{win:"Ctrl-M",mac:"Command-M"},exec:function(e){x(e)},readOnly:!0}),e(".markdown-bold[data-field-name="+a+"]").click(function(){g(s)}),e(".markdown-italic[data-field-name="+a+"]").click(function(){f(s)}),e(".markdown-horizontal[data-field-name="+a+"]").click(function(){v(s)}),e(".markdown-h1[data-field-name="+a+"]").click(function(){p(s)}),e(".markdown-h2[data-field-name="+a+"]").click(function(){w(s)}),e(".markdown-h3[data-field-name="+a+"]").click(function(){k(s)}),e(".markdown-pre[data-field-name="+a+"]").click(function(){C(s)}),e(".markdown-code[data-field-name="+a+"]").click(function(){h(s)}),e(".markdown-blockquote[data-field-name="+a+"]").click(function(){y(s)}),e(".markdown-unordered-list[data-field-name="+a+"]").click(function(){T(s)}),e(".markdown-ordered-list[data-field-name="+a+"]").click(function(){S(s)}),e(".markdown-link[data-field-name="+a+"]").click(function(){R(s)}),e(".markdown-image-link[data-field-name="+a+"]").click(function(){b(s)});var P=e(".markdown-direct-mention[data-field-name="+a+"]"),j=e(".markdown-image-upload[data-field-name="+a+"]");"true"===l.mention&&"true"===l.imgur?(P.click(function(){x(s)}),j.on("change",function(e){e.preventDefault(),O(s)})):"true"===l.mention&&"false"===l.imgur?(P.click(function(){x(s)}),j.remove()):"false"===l.mention&&"true"===l.imgur?(P.remove(),j.on("change",function(e){e.preventDefault(),O(s)})):(P.remove(),j.remove(),e(".markdown-reference tbody tr")[1].remove()),e(".markdown-help[data-field-name="+a+"]").click(function(){e(".modal-help-guide[data-field-name="+a+"]").modal("show")});var E=e(o),K=e(".martor-field-"+a),z=function(){e(document.body).removeClass("overflow"),e(this).attr({title:"Full Screen"}),e(this).find(".minimize.icon").removeClass("minimize").addClass("maximize"),e(".main-martor-fullscreen").find(".martor-preview").removeAttr("style"),E.removeClass("main-martor-fullscreen"),K.removeAttr("style"),s.resize()};e(".markdown-toggle-maximize[data-field-name="+a+"]").on("click",function(){!function(n){n.attr({title:"Minimize"}),n.find(".maximize.icon").removeClass("maximize").addClass("minimize"),E.addClass("main-martor-fullscreen");var o=document.body.clientHeight-90;K.attr({style:"height:"+o+"px"}),e(".main-martor-fullscreen").find(".martor-preview").attr({style:"overflow-y: auto;height:"+o+"px"}),s.resize(),n.one("click",z),e(document.body).addClass("overflow")}(e(this))}),e(document).keyup(function(n){27==n.keyCode&&E.hasClass("main-martor-fullscreen")&&e(".minimize.icon").trigger("click")}),e(".markdown-emoji[data-field-name="+a+"]").click(function(){var n=e(".modal-emoji[data-field-name="+a+"]"),o=emojis,t=n.find(".emoji-content-body"),r=n.find(".emoji-loader-init");t.html(""),r.show(),n.modal({onVisible:function(){for(var a=0;a<o.length;a++){var l=i.data("base-emoji-url")+o[a].replace(/:/g,"")+".png";t.append('<div class="four wide column"><p><a data-emoji-target="'+o[a]+'" class="insert-emoji"><img class="marked-emoji" src="'+l+'"> '+o[a]+"</a></p></div>"),e('a[data-emoji-target="'+o[a]+'"]').click(function(){var o,t,a;o=s,t=e(this).data("emoji-target"),a=o.getCursorPosition(),o.session.insert(a," "+t+" "),o.selection.moveTo(a.row,a.column+t.length+2),n.modal("hide",100)})}r.hide(),n.modal("refresh")}}).modal("show")}),""!=i.val()&&s.setValue(i.val())})},e(function(){e(".martor").martor()})}(jQuery);

$( document ).ready(function(){
    $('.ui.martor-toolbar .ui.dropdown').dropdown();
    $('.ui.tab-martor-menu .item').tab();
});
