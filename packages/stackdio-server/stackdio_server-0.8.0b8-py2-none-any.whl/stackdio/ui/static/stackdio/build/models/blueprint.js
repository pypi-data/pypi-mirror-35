/*!
  * Copyright 2017,  Digital Reasoning
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *
*/

define(["jquery","knockout","bootbox","utils/utils","models/host-definition"],function(t,e,r,s,i){"use strict";function o(t,r){var s=!1;"string"==typeof t&&(t=parseInt(t)),"number"==typeof t&&(s=!0,t={id:t,url:"/api/blueprints/"+t+"/"}),this.raw=t,this.parent=r,this.id=t.id,this.detailUrl="/blueprints/"+this.id+"/",this.title=e.observable(),this.description=e.observable(),this.createUsers=e.observable(),this.labelList=e.observable(),this.stackCount=e.observable(),this.properties=e.observable({}),this.hostDefinitions=e.observableArray([]),this.formulaVersions=e.observableArray([]),s?this.waiting=this.reload():this._process(t)}return o.constructor=o,o.prototype._process=function(t){this.title(t.title),this.description(t.description),this.createUsers(t.create_users),this.labelList(t.label_list),this.stackCount(t.stack_count)},o.prototype.reload=function(){var e=this;return t.ajax({method:"GET",url:this.raw.url}).done(function(t){e.raw=t,e._process(t)})},o.prototype.loadProperties=function(){var e=this;return this.raw.hasOwnProperty("properties")||(this.raw.properties=this.raw.url+"properties/"),t.ajax({method:"GET",url:this.raw.properties}).done(function(t){e.properties(t)})},o.prototype.saveProperties=function(){t.ajax({method:"PUT",url:this.raw.properties,data:JSON.stringify(this.properties())}).done(function(t){s.growlAlert("Successfully saved blueprint properties!","success")}).fail(function(t){var e;try{var r=JSON.parse(t.responseText);e=r.properties.join("<br>")}catch(t){e="Oops... there was a server error."}e+="  Your properties were not saved.",s.growlAlert(e,"danger")})},o.prototype.loadHostDefinitions=function(){function e(o){t.ajax({method:"GET",url:o}).done(function(t){s.push.apply(s,t.results.map(function(t){return new i(t,r.parent)})),null===t.next?r.hostDefinitions(s):e(t.next)})}var r=this,s=[];e(this.raw.host_definitions)},o.prototype.save=function(){var e=this,r=["title","description","create_users"];r.forEach(function(e){var r=t("#"+e);r.removeClass("has-error"),r.find(".help-block").remove()}),t.ajax({method:"PUT",url:e.raw.url,data:JSON.stringify({title:e.title(),description:e.description(),create_users:e.createUsers()})}).done(function(t){s.growlAlert("Successfully saved blueprint!","success");try{e.parent.blueprintTitle(t.title)}catch(t){}}).fail(function(t){s.parseSaveError(t,"blueprint",r)})},o.prototype.launch=function(){window.location="/stacks/create/?blueprint="+this.id},o.prototype.delete=function(){var e=this,s=this.title();r.confirm({title:"Confirm delete of <strong>"+s+"</strong>",message:"Are you sure you want to delete <strong>"+s+"</strong>?",buttons:{confirm:{label:"Delete",className:"btn-danger"}},callback:function(s){s&&t.ajax({method:"DELETE",url:e.raw.url}).done(function(){"/blueprints/"!==window.location.pathname?window.location="/blueprints/":e.parent&&"function"==typeof e.parent.reload&&e.parent.reload()}).fail(function(t){var e;try{var s=JSON.parse(t.responseText);e=s.detail.join("<br>"),Object.keys(s).indexOf("stacks")>=0&&(e+="<br><br>Stacks:<ul><li>"+s.stacks.join("</li><li>")+"</li></ul>")}catch(t){e="Oops... there was a server error.  This has been reported to your administrators."}r.alert({title:"Error deleting blueprint",message:e})})}})},o});