/*!
  * Copyright 2017,  Digital Reasoning
  *
  * Licensed under the Apache License, Version 2.0 (the "License");
  * you may not use this file except in compliance with the License.
  * You may obtain a copy of the License at
  *
  *     http://www.apache.org/licenses/LICENSE-2.0
  *
  * Unless required by applicable law or agreed to in writing, software
  * distributed under the License is distributed on an "AS IS" BASIS,
  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  * See the License for the specific language governing permissions and
  * limitations under the License.
  *
*/

define(["jquery","knockout","utils/class","fuelux"],function(e,t,s){"use strict";return s.extend({breadcrumbs:[],model:null,baseUrl:null,initialUrl:null,sortableFields:[],autoRefresh:!0,detailRequiresAdvanced:!1,pageNum:t.observable(),pageSize:t.observable(),currentPage:t.observable(),previousPage:t.observable(),nextPage:t.observable(),count:t.observable(),objects:t.observableArray([]),loading:t.observable(),sortKey:t.observable(),sortAsc:t.observable(!0),permissionsMap:window.stackdio.permissionsMap,sortedObjects:null,startNum:null,endNum:null,numPages:null,searchInput:e("#search-input"),shouldReset:!0,init:function(){this.reset();var s=this,i=e("#pagination-search");i.search(),i.on("searched.fu.search",function(){s.currentPage(s.initialUrl+"?q="+s.searchInput.val()),s.shouldReset=!1,s.reset()}),i.on("cleared.fu.search",function(){s.reset()}),this.sortedObjects=t.computed(function(){var e=this.sortKey();if(!this.sortableFields)return this.objects();var t=this.sortableFields.map(function(e){return e.name}),s=this,i=s.objects();return t.indexOf(e)<0?i:i.sort(function(t,i){if(!s.sortAsc()){var n=t;t=i,i=n}return t[e]()<i[e]()?-1:t[e]()>i[e]()?1:0})},this),this.startNum=t.computed(function(){return null===this.pageSize()?this.count()>0?1:0:(this.pageNum()-1)*this.pageSize()+1},this),this.endNum=t.computed(function(){return null===this.pageSize()?this.objects().length:this.startNum()+Math.min(this.pageSize(),this.objects().length)-1},this),this.numPages=t.computed(function(){if(null===this.pageSize())return 1;var e=this.count()/this.pageSize();return this.count()%this.pageSize()==0?e:e+1},this),this.numFailures=0,this.autoRefresh&&(this.intervalId=setInterval(function(e){return function(){e.reload()}}(this),3e3))},reset:function(){this.pageNum(1),this.pageSize(null),this.shouldReset&&(this.currentPage(this.initialUrl),this.sortKey(null),this.sortAsc(!0)),this.previousPage(null),this.nextPage(null),this.count(0),this.objects([]),this.loading(!1),this.shouldReset=!0,this.reload(!0)},changeSortKey:function(e){var t=this.sortKey();e.name===t?this.sortAsc(!this.sortAsc()):this.sortKey(e.name)},canDisplayDetail:function(){return!this.detailRequiresAdvanced||window.stackdio.advancedView},goToNextPage:function(){null!==this.nextPage()&&(this.currentPage(this.nextPage()),this.pageNum(this.pageNum()+1),this.reload(!0))},goToPreviousPage:function(){null!==this.previousPage()&&(this.currentPage(this.previousPage()),this.pageNum(this.pageNum()-1),this.reload(!0))},processObject:function(e){},extraReloadSteps:function(){},filterObject:function(e){return!0},reload:function(t){void 0===t&&(t=!1),t&&this.loading(!0);var s=this;e.ajax({method:"GET",url:this.currentPage()}).done(function(e){s.numFailures=0,s.count(e.count),s.previousPage(e.previous),s.nextPage(e.next),null!==e.next&&s.pageSize(e.results.length),s.objects(e.results.filter(s.filterObject).map(function(e){var t=new s.model(e,s);return s.processObject(t),t})),s.extraReloadSteps()}).fail(function(e){403==e.status?window.location.reload(!0):(s.numFailures>=5?(console.warn("Too many ajax failures. Stopping refresh polling."),clearInterval(s.intervalId),s.intervalId=null):s.reset(),s.numFailures+=1)}).always(function(){s.loading(!1)})}})});