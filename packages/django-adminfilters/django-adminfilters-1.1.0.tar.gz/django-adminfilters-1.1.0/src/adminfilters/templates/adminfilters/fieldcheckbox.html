{% load i18n %}
<h3>{% blocktrans with title as filter_title %} By {{ filter_title }}{% endblocktrans %}</h3>
<div id="field-{{ spec.field.name }}">
    <ul>
    {% for choice in choices %}
        <li><label>
        <input type="checkbox"{% if choice.selected %} checked="checked"{% endif %}
        data-uncheck-to-remove="{{ choice.uncheck_to_remove }}" value="{{ choice.query_string }}"/> {{ choice.display }}
        </label>
        </li>
    {% endfor %}
    </ul>
</div>
<script type="text/javascript">
    Array.prototype.unique = function(){
       var u = {}, a = [];
       for(var i = 0, l = this.length; i < l; ++i){
          if(this[i] in u)
             continue;
          a.push(this[i]);
          u[this[i]] = 1;
       }
       return a;
    };
    (function($){
        $('#field-{{ spec.field.name }} input[type=checkbox]').change(function(){
            var rex = /(.*)\?(.*)/gi;
            var m = rex.exec(location.href);
            var current_checkbox = $(this);
            var uncheckbox_to_remove = current_checkbox.data('uncheck-to-remove');

            if(m) {
                var base = m[1];
                var params = m[2].split("&");
            }else {
                var base = location.href;
                var params = [];
            }
            var filter = current_checkbox.val().replace("?", "").split('&');

            if ( filter == "" ){
                location.href = base;
                return;
            }


            if (current_checkbox.is(':checked')){
                Array.prototype.push.apply(params, filter);
            }else {
                params.splice(params.indexOf(uncheckbox_to_remove), 1);
            }

            var loc =  base + "?" + params.unique().join("&");

            if(uncheckbox_to_remove == '') {
                location.href = current_checkbox.val();
            } else
                location.href = loc;
        });
    })(django.jQuery);
</script>
