
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>aglyph.context &#8212; Aglyph 3.0.0.post1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for aglyph.context</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: UTF-8 -*-</span>

<span class="c1"># Copyright (c) 2006, 2011, 2013-2018 Matthew Zipay.</span>
<span class="c1">#</span>
<span class="c1"># Permission is hereby granted, free of charge, to any person</span>
<span class="c1"># obtaining a copy of this software and associated documentation</span>
<span class="c1"># files (the &quot;Software&quot;), to deal in the Software without</span>
<span class="c1"># restriction, including without limitation the rights to use,</span>
<span class="c1"># copy, modify, merge, publish, distribute, sublicense, and/or sell</span>
<span class="c1"># copies of the Software, and to permit persons to whom the</span>
<span class="c1"># Software is furnished to do so, subject to the following</span>
<span class="c1"># conditions:</span>
<span class="c1">#</span>
<span class="c1"># The above copyright notice and this permission notice shall be</span>
<span class="c1"># included in all copies or substantial portions of the Software.</span>
<span class="c1">#</span>
<span class="c1"># THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND,</span>
<span class="c1"># EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES</span>
<span class="c1"># OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND</span>
<span class="c1"># NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT</span>
<span class="c1"># HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,</span>
<span class="c1"># WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING</span>
<span class="c1"># FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR</span>
<span class="c1"># OTHER DEALINGS IN THE SOFTWARE.</span>

<span class="sd">&quot;&quot;&quot;The classes in this module are used to define collections</span>
<span class="sd">(&quot;contexts&quot;) of related components and templates.</span>

<span class="sd">A context can be created in pure Python using the following API classes:</span>

<span class="sd">* :class:`aglyph.component.Template`</span>
<span class="sd">* :class:`aglyph.component.Component`</span>
<span class="sd">* :class:`aglyph.component.Reference` (used to indicate that one</span>
<span class="sd">  component depends on another component)</span>
<span class="sd">* :class:`aglyph.component.Evaluator` (used like a partial function to</span>
<span class="sd">  lazily evaluate component initialization arguments and attributes)</span>
<span class="sd">* :class:`aglyph.context.Context` or a subclass</span>

<span class="sd">.. versionadded:: 3.0.0</span>
<span class="sd">   For easier programmatic configuration, refer to</span>
<span class="sd">   :doc:`context-fluent-api`.</span>

<span class="sd">Alternatively, a context can be defined using a declarative XML syntax</span>
<span class="sd">that conforms to the :download:`Aglyph context DTD</span>
<span class="sd">&lt;../../resources/aglyph-context.dtd&gt;` (included in the *resources/*</span>
<span class="sd">directory of the distribution). This approach requires only the</span>
<span class="sd">:class:`aglyph.context.XMLContext` class, which parses the XML document</span>
<span class="sd">and then uses the API classes mentioned above to populate the context.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__author__</span> <span class="o">=</span> <span class="s2">&quot;Matthew Zipay &lt;mattz@ninthtest.info&gt;&quot;</span>

<span class="kn">from</span> <span class="nn">ast</span> <span class="k">import</span> <span class="n">literal_eval</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">xml.etree.ElementTree</span> <span class="k">as</span> <span class="nn">ET</span>

<span class="kn">from</span> <span class="nn">autologging</span> <span class="k">import</span> <span class="n">logged</span><span class="p">,</span> <span class="n">traced</span>

<span class="kn">from</span> <span class="nn">aglyph</span> <span class="k">import</span> <span class="n">AglyphError</span><span class="p">,</span> <span class="n">_identify</span><span class="p">,</span> <span class="n">__version__</span>
<span class="kn">from</span> <span class="nn">aglyph._compat</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">AglyphDefaultXMLParser</span><span class="p">,</span>
    <span class="n">DataType</span><span class="p">,</span>
    <span class="n">DoctypeTreeBuilder</span><span class="p">,</span>
    <span class="n">is_python_3</span><span class="p">,</span>
    <span class="n">name_of</span><span class="p">,</span>
    <span class="n">TextType</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">aglyph.component</span> <span class="k">import</span> <span class="p">(</span>
    <span class="n">Component</span><span class="p">,</span>
    <span class="n">Evaluator</span> <span class="k">as</span> <span class="n">evaluate</span><span class="p">,</span>
    <span class="n">Reference</span> <span class="k">as</span> <span class="n">ref</span><span class="p">,</span>
    <span class="n">Strategy</span><span class="p">,</span>
    <span class="n">Template</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Context&quot;</span><span class="p">,</span> <span class="s2">&quot;evaluate&quot;</span><span class="p">,</span> <span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="s2">&quot;XMLContext&quot;</span><span class="p">]</span>

<span class="n">_log</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_ContextBuilder</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Entry points for the Aglyph Context fluent API.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="_ContextBuilder.component"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._ContextBuilder.component">[docs]</a>    <span class="k">def</span> <span class="nf">component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a fluent :class:`Component` builder for</span>
<span class="sd">        *component_id_spec*.</span>

<span class="sd">        :arg component_id_spec:</span>
<span class="sd">           a context-unique identifier for this component; or the object</span>
<span class="sd">           whose dotted name will identify this component</span>
<span class="sd">        :keyword parent:</span>
<span class="sd">           the context-unique identifier for this component&#39;s parent</span>
<span class="sd">           template or component definition; or the object whose dotted</span>
<span class="sd">           name identifies this component&#39;s parent definition</span>

<span class="sd">        .. versionadded:: 3.0.0</span>
<span class="sd">           This method is an entry point into :doc:`context-fluent-api`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_ComponentBuilder</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ContextBuilder.prototype"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._ContextBuilder.prototype">[docs]</a>    <span class="k">def</span> <span class="nf">prototype</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :data:`prototype &lt;aglyph.component.Strategy&gt;`</span>
<span class="sd">        :class:`Component` builder for a component identified by</span>
<span class="sd">        *component_id_spec*.</span>

<span class="sd">        :arg component_id_spec:</span>
<span class="sd">           a context-unique identifier for this component; or the object</span>
<span class="sd">           whose dotted name will identify this component</span>
<span class="sd">        :keyword parent:</span>
<span class="sd">           the context-unique identifier for this component&#39;s parent</span>
<span class="sd">           template or component definition; or the object whose dotted</span>
<span class="sd">           name identifies this component&#39;s parent definition</span>

<span class="sd">        .. versionadded:: 3.0.0</span>
<span class="sd">           This method is an entry point into :doc:`context-fluent-api`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">(</span>
            <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;prototype&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ContextBuilder.singleton"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._ContextBuilder.singleton">[docs]</a>    <span class="k">def</span> <span class="nf">singleton</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :data:`singleton &lt;aglyph.component.Strategy&gt;`</span>
<span class="sd">        :class:`Component` builder for a component identified by</span>
<span class="sd">        *component_id_spec*.</span>

<span class="sd">        :arg component_id_spec:</span>
<span class="sd">           a context-unique identifier for this component; or the object</span>
<span class="sd">           whose dotted name will identify this component</span>
<span class="sd">        :keyword parent:</span>
<span class="sd">           the context-unique identifier for this component&#39;s parent</span>
<span class="sd">           template or component definition; or the object whose dotted</span>
<span class="sd">           name identifies this component&#39;s parent definition</span>

<span class="sd">        .. versionadded:: 3.0.0</span>
<span class="sd">           This method is an entry point into :doc:`context-fluent-api`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">(</span>
            <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;singleton&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ContextBuilder.borg"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._ContextBuilder.borg">[docs]</a>    <span class="k">def</span> <span class="nf">borg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :data:`borg &lt;aglyph.component.Strategy&gt;`</span>
<span class="sd">        :class:`Component` builder for a component identified by</span>
<span class="sd">        *component_id_spec*.</span>

<span class="sd">        :arg component_id_spec:</span>
<span class="sd">           a context-unique identifier for this component; or the object</span>
<span class="sd">           whose dotted name will identify this component</span>
<span class="sd">        :keyword parent:</span>
<span class="sd">           the context-unique identifier for this component&#39;s parent</span>
<span class="sd">           template or component definition; or the object whose dotted</span>
<span class="sd">           name identifies this component&#39;s parent definition</span>

<span class="sd">        .. versionadded:: 3.0.0</span>
<span class="sd">           This method is an entry point into :doc:`context-fluent-api`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">(</span>
            <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;borg&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ContextBuilder.weakref"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._ContextBuilder.weakref">[docs]</a>    <span class="k">def</span> <span class="nf">weakref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :data:`weakref &lt;aglyph.component.Strategy&gt;`</span>
<span class="sd">        :class:`Component` builder for a component identified by</span>
<span class="sd">        *component_id_spec*.</span>

<span class="sd">        :arg component_id_spec:</span>
<span class="sd">           a context-unique identifier for this component; or the object</span>
<span class="sd">           whose dotted name will identify this component</span>
<span class="sd">        :keyword parent:</span>
<span class="sd">           the context-unique identifier for this component&#39;s parent</span>
<span class="sd">           template or component definition; or the object whose dotted</span>
<span class="sd">           name identifies this component&#39;s parent definition</span>

<span class="sd">        .. versionadded:: 3.0.0</span>
<span class="sd">           This method is an entry point into :doc:`context-fluent-api`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">component</span><span class="p">(</span>
            <span class="n">component_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
                <span class="n">strategy</span><span class="o">=</span><span class="s2">&quot;weakref&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="_ContextBuilder.template"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._ContextBuilder.template">[docs]</a>    <span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class:`Template` builder for a template identified</span>
<span class="sd">        by *template_spec*.</span>

<span class="sd">        :arg template_id_spec:</span>
<span class="sd">           a context-unique identifier for this template; or the object</span>
<span class="sd">           whose dotted name will identify this template</span>
<span class="sd">        :keyword parent:</span>
<span class="sd">           the context-unique identifier for this template&#39;s parent</span>
<span class="sd">           template or component definition; or the object whose dotted</span>
<span class="sd">           name identifies this template&#39;s parent definition</span>

<span class="sd">        .. versionadded:: 3.0.0</span>
<span class="sd">           This method is an entry point into :doc:`context-fluent-api`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_TemplateBuilder</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">template_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span></div>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_CreationBuilderMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods to describe object creation.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="_CreationBuilderMixin.create"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._CreationBuilderMixin.create">[docs]</a>    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">dotted_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">factory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">member</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify the object creation aspects of a component being</span>
<span class="sd">        defined.</span>

<span class="sd">        :keyword dotted_name:</span>
<span class="sd">           an **importable** dotted name or an object whose dotted name</span>
<span class="sd">           will be introspected</span>
<span class="sd">        :keyword factory:</span>
<span class="sd">           names a :obj:`callable` member of the object represented by</span>
<span class="sd">           the dotted name</span>
<span class="sd">        :keyword member:</span>
<span class="sd">           names **any** member of the object represented by the dotted</span>
<span class="sd">           name</span>
<span class="sd">        :keyword strategy:</span>
<span class="sd">           specifies the component assembly strategy</span>
<span class="sd">        :return:</span>
<span class="sd">           *self* (to support chained calls)</span>

<span class="sd">        Any keyword whose value is ``None`` will be ignored (i.e.</span>
<span class="sd">        ``None`` values are not explicitly set).</span>

<span class="sd">        .. note::</span>
<span class="sd">           The *member* and *strategy* keywords should be treated as</span>
<span class="sd">           mutually exclusive. Any component definition that specifies a</span>
<span class="sd">           *member* is implicitly assigned the special strategy</span>
<span class="sd">           &quot;_imported&quot;.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># do not explicitly assign None values; calls can be chained</span>
        <span class="k">if</span> <span class="n">dotted_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_dotted_name_spec</span> <span class="o">=</span> <span class="n">dotted_name</span>
        <span class="k">if</span> <span class="n">factory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_factory_name</span> <span class="o">=</span> <span class="n">factory</span>
        <span class="k">if</span> <span class="n">member</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_member_name</span> <span class="o">=</span> <span class="n">member</span>
        <span class="k">if</span> <span class="n">strategy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="n">strategy</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_InjectionBuilderMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods to describe injected dependencies.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="_InjectionBuilderMixin.init"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._InjectionBuilderMixin.init">[docs]</a>    <span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">keywords</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify the initialization arguments (positional and</span>
<span class="sd">        keyword) for templates and/or components.</span>

<span class="sd">        :arg tuple args:</span>
<span class="sd">           the positional initialization arguments</span>
<span class="sd">        :arg dict keywords:</span>
<span class="sd">           the keyword initialization arguments</span>
<span class="sd">        :return:</span>
<span class="sd">           *self* (to support chained calls)</span>

<span class="sd">        .. note::</span>
<span class="sd">           Successive calls to this method on the same instance have a</span>
<span class="sd">           cumulative effect; the list of positional arguments is</span>
<span class="sd">           extended, and the dictionary of keyword arguments is updated.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">keywords</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="_InjectionBuilderMixin.set"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._InjectionBuilderMixin.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify the setter (method/attribute/property) depdendencies</span>
<span class="sd">        for tempaltes and/or components.</span>

<span class="sd">        :arg pairs:</span>
<span class="sd">           a sequence of (name, value) 2-tuples (optional)</span>
<span class="sd">        :arg attributes:</span>
<span class="sd">           a mapping of name-&gt;value dependencies</span>
<span class="sd">        :return:</span>
<span class="sd">           *self* (to support chained calls)</span>

<span class="sd">        .. note::</span>
<span class="sd">           Successive calls to this method on the same instance have a</span>
<span class="sd">           cumulative effect (i.e. the attributes mapping is updated).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pairs</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_LifecycleBuilderMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods to describe lifecyle method names.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="_LifecycleBuilderMixin.call"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._LifecycleBuilderMixin.call">[docs]</a>    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">after_inject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">before_clear</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Specify the names of lifecycle methods to be called for</span>
<span class="sd">        templates and/or components.</span>

<span class="sd">        :arg after_inject:</span>
<span class="sd">           the name of the method to call after a component has been</span>
<span class="sd">           assembled but before it is returned to the caller</span>
<span class="sd">        :arg before_clear:</span>
<span class="sd">           the name of the method to call immediately before a</span>
<span class="sd">           *singleton*, *borg*, or *weakref* object is evicted from</span>
<span class="sd">           the internal cache</span>
<span class="sd">        :return:</span>
<span class="sd">           *self* (to support chained calls)</span>

<span class="sd">        Any keyword whose value is ``None`` will be ignored (i.e.</span>
<span class="sd">        ``None`` values are not explicitly set).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># do not explicitly assign None values; calls can be chained</span>
        <span class="k">if</span> <span class="n">after_inject</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span> <span class="o">=</span> <span class="n">after_inject</span>
        <span class="k">if</span> <span class="n">before_clear</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span> <span class="o">=</span> <span class="n">before_clear</span>
        <span class="k">return</span> <span class="bp">self</span></div>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_RegistrationMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Methods to handle registering a template or component in a</span>
<span class="sd">    context.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[]</span>

<div class="viewcode-block" id="_RegistrationMixin.register"><a class="viewcode-back" href="../../context-fluent-api.html#aglyph.context._RegistrationMixin.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a component or template definition to a context.</span>

<span class="sd">        :return:</span>
<span class="sd">           ``None`` (terminates the fluent call sequence)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">definition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_definition</span><span class="p">()</span>

        <span class="n">definition</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_args</span>
        <span class="n">definition</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span>
        <span class="n">definition</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">definition</span><span class="p">)</span></div>
        <span class="c1"># implicit return None terminates this fluent call sequence</span>

    <span class="k">def</span> <span class="nf">_init_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the :class:`Component` or :class:`Template` definition</span>
<span class="sd">        that will be registered in the :class:`Context`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_TemplateBuilder</span><span class="p">(</span>
        <span class="n">_InjectionBuilderMixin</span><span class="p">,</span> <span class="n">_LifecycleBuilderMixin</span><span class="p">,</span> <span class="n">_RegistrationMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fluent context builder for :class:`Template` definitions.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_context&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_unique_id_spec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_parent_id_spec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_args&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_keywords&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_attributes&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_after_inject&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_before_clear&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">unique_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="n">context</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unique_id_spec</span> <span class="o">=</span> <span class="n">unique_id_spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parent_id_spec</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keywords</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_attributes</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_init_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">_identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_id_spec</span><span class="p">),</span>
            <span class="n">parent_id</span><span class="o">=</span>
                <span class="n">_identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_id_spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_id_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">after_inject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span><span class="p">,</span>
            <span class="n">before_clear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span><span class="p">)</span>


<span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">_ComponentBuilder</span><span class="p">(</span><span class="n">_CreationBuilderMixin</span><span class="p">,</span> <span class="n">_TemplateBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fluent context builder for :class:`Component` definitions.&quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;_dotted_name_spec&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_factory_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_member_name&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_strategy&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">unique_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">_TemplateBuilder</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">unique_id_spec</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">parent</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_dotted_name_spec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_factory_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_member_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_init_definition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Component</span><span class="p">(</span>
            <span class="n">_identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_unique_id_spec</span><span class="p">),</span>
            <span class="n">dotted_name</span><span class="o">=</span>
                <span class="n">_identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dotted_name_spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dotted_name_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">factory_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_factory_name</span><span class="p">,</span>
            <span class="n">member_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_member_name</span><span class="p">,</span>
            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_strategy</span><span class="p">,</span>
            <span class="n">parent_id</span><span class="o">=</span>
                <span class="n">_identify</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parent_id_spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parent_id_spec</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">after_inject</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span><span class="p">,</span>
            <span class="n">before_clear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span><span class="p">)</span>


<div class="viewcode-block" id="Context"><a class="viewcode-back" href="../../aglyph.context.html#aglyph.context.Context">[docs]</a><span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">Context</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">_ContextBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A mapping of unique IDs to :class:`Component` and</span>
<span class="sd">    :class:`Template` objects.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context_id</span><span class="p">,</span> <span class="n">after_inject</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">before_clear</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg str context_id:</span>
<span class="sd">           an identifier for this context</span>
<span class="sd">        :keyword str after_inject:</span>
<span class="sd">           specifies the name of the method that will be called (if it</span>
<span class="sd">           exists) on **all** component objects after all of their</span>
<span class="sd">           dependencies have been injected</span>
<span class="sd">        :keyword str before_clear:</span>
<span class="sd">           specifies the name of the method that will be called (if it</span>
<span class="sd">           exists) on **all** singleton, borg, and weakref objects</span>
<span class="sd">           immediately before they are cleared from cache</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#PYVER: arguments to super() are implicit under Python 3</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Context</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">context_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> ID must not be None or empty&quot;</span> <span class="o">%</span> <span class="n">name_of</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_context_id</span> <span class="o">=</span> <span class="n">context_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span> <span class="o">=</span> <span class="n">after_inject</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span> <span class="o">=</span> <span class="n">before_clear</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">context_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The context identifier *(read-only)*.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">after_inject</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of the component object method that will be called</span>
<span class="sd">        after **all** dependencies have been injected into that</span>
<span class="sd">        component object *(read-only)*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">before_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The name of the component object method that will be called</span>
<span class="sd">        immediately before the object is cleared from cache</span>
<span class="sd">        *(read-only)*.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           This property is not applicable to &quot;prototype&quot; component</span>
<span class="sd">           objects, or to component objects acquired via</span>
<span class="sd">           :attr:`Component.member_name`.</span>
<span class="sd">           The named method is **not guaranteed** to be called for</span>
<span class="sd">           &quot;weakref&quot; component objects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span>

<div class="viewcode-block" id="Context.register"><a class="viewcode-back" href="../../aglyph.context.html#aglyph.context.Context.register">[docs]</a>    <span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">definition</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a component or template *definition* to this context.</span>

<span class="sd">        :arg definition:</span>
<span class="sd">           a :class:`Component` or :class:`Template` object</span>
<span class="sd">        :raise AglyphError:</span>
<span class="sd">           if a component or template with the same unique ID is already</span>
<span class="sd">           registered in this context</span>

<span class="sd">        .. note::</span>
<span class="sd">           To **replace** an already-registered component or template</span>
<span class="sd">           with the same unique ID, use :meth:`dict.__setitem__`</span>
<span class="sd">           directly.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">definition</span><span class="o">.</span><span class="n">unique_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> with ID </span><span class="si">%r</span><span class="s2"> already mapped in </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">name_of</span><span class="p">(</span><span class="n">definition</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),</span> <span class="n">definition</span><span class="o">.</span><span class="n">unique_id</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>
        <span class="bp">self</span><span class="p">[</span><span class="n">definition</span><span class="o">.</span><span class="n">unique_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">definition</span></div>

<div class="viewcode-block" id="Context.get_component"><a class="viewcode-back" href="../../aglyph.context.html#aglyph.context.Context.get_component">[docs]</a>    <span class="k">def</span> <span class="nf">get_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`Component` identified by *component_id*.</span>

<span class="sd">        :arg str component_id:</span>
<span class="sd">           a unique ID that identifies a :class:`Component`</span>
<span class="sd">        :return:</span>
<span class="sd">           the :class:`Component` identified by *component_id*</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`Component` if *component_id* is mapped, else ``None``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">component_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Component</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Context.iter_components"><a class="viewcode-back" href="../../aglyph.context.html#aglyph.context.Context.iter_components">[docs]</a>    <span class="k">def</span> <span class="nf">iter_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">strategy</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield all definitions in this context that are instances of</span>
<span class="sd">        :class:`Component`, optionally filtered by *strategy*.</span>

<span class="sd">        :keyword str strategy:</span>
<span class="sd">           only yield component definitions that use this assembly</span>
<span class="sd">           strategy (by default, **all** component definitions are</span>
<span class="sd">           yielded)</span>
<span class="sd">        :return:</span>
<span class="sd">           a :class:`Component` generator</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Component</span><span class="p">)</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">strategy</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">strategy</span><span class="p">])):</span>
                <span class="k">yield</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%r</span><span class="s2"> @</span><span class="si">%08x</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">name_of</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_context_id</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, after_inject=</span><span class="si">%r</span><span class="s2">, before_clear=</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">name_of</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_context_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_after_inject</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_before_clear</span><span class="p">)</span></div>


<div class="viewcode-block" id="XMLContext"><a class="viewcode-back" href="../../aglyph.context.html#aglyph.context.XMLContext">[docs]</a><span class="nd">@traced</span>
<span class="nd">@logged</span>
<span class="k">class</span> <span class="nc">XMLContext</span><span class="p">(</span><span class="n">Context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A mapping of unique IDs to :class:`Component` and</span>
<span class="sd">    :class:`Template` objects.</span>

<span class="sd">    Components and templates are declared in an XML document that</span>
<span class="sd">    conforms to the :download:`Aglyph context DTD</span>
<span class="sd">    &lt;../../resources/aglyph-context.dtd&gt;` (included in the *resources/*</span>
<span class="sd">    directory of the distribution).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">default_encoding</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">getdefaultencoding</span><span class="p">()):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg source:</span>
<span class="sd">           a filename or stream from which XML data is read</span>
<span class="sd">        :keyword xml.etree.ElementTree.XMLParser parser:</span>
<span class="sd">           the ElementTree parser to use (instead of Aglyph&#39;s default)</span>
<span class="sd">        :keyword str default_encoding:</span>
<span class="sd">           the default character set used to encode certain element</span>
<span class="sd">           content</span>
<span class="sd">        :raise AglyphError:</span>
<span class="sd">           if unexpected elements are encountered, or if expected</span>
<span class="sd">           elements are *not* encountered, in the document structure</span>

<span class="sd">        In most cases, *parser* should be left unspecified. Aglyph&#39;s</span>
<span class="sd">        default parser will be sufficient for all but extreme edge</span>
<span class="sd">        cases.</span>

<span class="sd">        *default_encoding* is the character set used to encode</span>
<span class="sd">        ``&lt;bytes&gt;`` (or ``&lt;str&gt;`` under Python 2) element content when</span>
<span class="sd">        an **@encoding** attribute is *not* specified on those elements.</span>
<span class="sd">        It defaults to the system-dependent value of</span>
<span class="sd">        :func:`sys.getdefaultencoding`. **This is not related to the</span>
<span class="sd">        document encoding!**</span>

<span class="sd">        .. note::</span>
<span class="sd">           Aglyph uses a non-validating XML parser by default, so DTD</span>
<span class="sd">           conformance is **not** enforced at runtime. It is recommended</span>
<span class="sd">           that XML contexts be validated at least once (manually)</span>
<span class="sd">           during testing.</span>

<span class="sd">           An :class:`AglyphError` *will* be raised under certain</span>
<span class="sd">           conditions (an unexpected element is encounted, or an</span>
<span class="sd">           expected element is *not* encountered), but Aglyph does not</span>
<span class="sd">           &quot;reinvent the wheel&quot; by implementing strict validation in</span>
<span class="sd">           the parsing logic.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           Although Aglyph contexts are :class:`dict` types,</span>
<span class="sd">           ``XMLContext`` does not permit the same unique ID to be</span>
<span class="sd">           (re-)mapped multiple times.</span>

<span class="sd">           Attempting to define more than one ``&lt;component&gt;`` or</span>
<span class="sd">           ``&lt;template&gt;`` with the same ID will raise</span>
<span class="sd">           :class:`AglyphError` when the document is parsed.</span>

<span class="sd">           **After** an Aglyph ``&lt;context&gt;`` document has been</span>
<span class="sd">           successfully parsed, a unique component or template ID can be</span>
<span class="sd">           re-mapped using standard :class:`dict` protocols.</span>

<span class="sd">           .. seealso::</span>
<span class="sd">              Validity constraint: ID</span>
<span class="sd">                 https://www.w3.org/TR/REC-xml/#id</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parser</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parser</span> <span class="o">=</span> <span class="n">AglyphDefaultXMLParser</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">DoctypeTreeBuilder</span><span class="p">())</span>
        <span class="n">tree</span> <span class="o">=</span> <span class="n">ET</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">parser</span><span class="o">=</span><span class="n">parser</span><span class="p">)</span>
        <span class="n">root</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">getroot</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;context&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span><span class="s2">&quot;expected root &lt;context&gt;, not &lt;</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="n">root</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

        <span class="c1">#PYVER: arguments to super() are implicit under Python 3</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">XMLContext</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span> <span class="n">after_inject</span><span class="o">=</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after-inject&quot;</span><span class="p">),</span>
            <span class="n">before_clear</span><span class="o">=</span><span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;before-clear&quot;</span><span class="p">))</span>

        <span class="c1"># alias the correct _parse_str method based on Python version</span>
        <span class="k">if</span> <span class="n">is_python_3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_str_as_text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__parse_str_as_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_default_encoding</span> <span class="o">=</span> <span class="n">default_encoding</span>

        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">root</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;component&quot;</span><span class="p">:</span>
                <span class="n">depsupport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_component</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">==</span> <span class="s2">&quot;template&quot;</span><span class="p">:</span>
                <span class="n">depsupport</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_template</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                    <span class="s2">&quot;unexpected element: /context/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">depsupport</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_dependencies</span><span class="p">(</span><span class="n">depsupport</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__repr</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, parser=</span><span class="si">%r</span><span class="s2">, default_encoding=</span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span> <span class="n">name_of</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">),</span>
            <span class="n">source</span><span class="p">,</span> <span class="n">parser</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The default encoding of ``&lt;bytes&gt;`` (or ``&lt;str&gt;`` under</span>
<span class="sd">        Python 2) element content when an **@encoding** attribute is</span>
<span class="sd">        *not* specified.</span>

<span class="sd">        .. note::</span>
<span class="sd">           This is **unrelated** to the document encoding!</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_encoding</span>

    <span class="k">def</span> <span class="nf">_create_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">template_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a template object from a ``&lt;template&gt;`` element.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element template_element:</span>
<span class="sd">           a ``&lt;template&gt;`` element</span>
<span class="sd">        :return:</span>
<span class="sd">           an Aglyph template object</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`aglyph.component.Template`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Template</span><span class="p">(</span>
            <span class="n">template_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
            <span class="n">parent_id</span><span class="o">=</span><span class="n">template_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent-id&quot;</span><span class="p">),</span>
            <span class="n">after_inject</span><span class="o">=</span><span class="n">template_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after-inject&quot;</span><span class="p">),</span>
            <span class="n">before_clear</span><span class="o">=</span><span class="n">template_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;before-clear&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_component</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">component_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a component object from a ``&lt;component&gt;`` element.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element component_element:</span>
<span class="sd">           a ``&lt;component&gt;`` element</span>
<span class="sd">        :return:</span>
<span class="sd">           an Aglyph component object</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`aglyph.component.Component`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Component</span><span class="p">(</span>
            <span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
            <span class="n">dotted_name</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dotted-name&quot;</span><span class="p">),</span>
            <span class="n">factory_name</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;factory-name&quot;</span><span class="p">),</span>
            <span class="n">member_name</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;member-name&quot;</span><span class="p">),</span>
            <span class="n">strategy</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">),</span>
            <span class="n">parent_id</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parent-id&quot;</span><span class="p">),</span>
            <span class="n">after_inject</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;after-inject&quot;</span><span class="p">),</span>
            <span class="n">before_clear</span><span class="o">=</span><span class="n">component_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;before-clear&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depsupport</span><span class="p">,</span> <span class="n">depsupport_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the child elements of *depsupport_element* to populate</span>
<span class="sd">        the *depsupport* initialization arguments and attributess.</span>

<span class="sd">        :arg depsupport:</span>
<span class="sd">           a :class:`Template` or :class:`Component`</span>
<span class="sd">        :arg xml.etree.ElementTree.Element depsupport_element:</span>
<span class="sd">           the ``&lt;template&gt;`` or ``&lt;component&gt;`` that was parsed to</span>
<span class="sd">           create *depsupport*</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">depsupport_element</span><span class="p">)</span>
        <span class="n">child_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">elem</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">child_tags</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">]:</span>
            <span class="n">init_element</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">attributes_element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">child_tags</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="s2">&quot;attributes&quot;</span><span class="p">]:</span>
            <span class="n">init_element</span><span class="p">,</span> <span class="n">attributes_element</span> <span class="o">=</span> <span class="n">children</span>
        <span class="k">elif</span> <span class="n">child_tags</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">]:</span>
            <span class="n">init_element</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">attributes_element</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">child_tags</span><span class="p">:</span>
            <span class="n">init_element</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">attributes_element</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dtag</span> <span class="o">=</span> <span class="n">depsupport_element</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                <span class="s2">&quot;unexpected element: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">depsupport_element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="n">child_tags</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">init_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_init</span><span class="p">(</span><span class="n">init_element</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">keyword</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">depsupport</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">depsupport</span><span class="o">.</span><span class="n">keywords</span><span class="p">[</span><span class="n">keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">if</span> <span class="n">attributes_element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_attributes</span><span class="p">(</span><span class="n">attributes_element</span><span class="p">):</span>
                <span class="n">depsupport</span><span class="o">.</span><span class="n">attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> has args=</span><span class="si">%r</span><span class="s2">, keywords=</span><span class="si">%r</span><span class="s2">, attributess=</span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">depsupport</span><span class="p">,</span> <span class="n">depsupport</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">depsupport</span><span class="o">.</span><span class="n">keywords</span><span class="p">,</span>
            <span class="n">depsupport</span><span class="o">.</span><span class="n">attributes</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield initialization arguments (positional and keyword)</span>
<span class="sd">        parsed from *init_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element init_element:</span>
<span class="sd">           an ``&lt;init&gt;`` element</span>
<span class="sd">        :return:</span>
<span class="sd">           an iterator that yields the 2-tuple ``(keyword, value)``</span>

<span class="sd">        .. note::</span>
<span class="sd">           Both positional and keyword arguments are yielded by this</span>
<span class="sd">           method as a 2-tuple ``(keyword, value)``. For positional</span>
<span class="sd">           arguments, ``keyword`` will be ``None``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">init_element</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;arg&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span><span class="s2">&quot;unexpected element: init/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">keyword</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keyword&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">keyword</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span><span class="s2">&quot;arg/@keyword cannot be empty&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unserialize_element_value</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attributes_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Yield attributes (fields, setter methods, or properties)</span>
<span class="sd">        parsed from *attributes_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element attributes_element:</span>
<span class="sd">           an ``&lt;attributes&gt;`` element</span>
<span class="sd">        :return:</span>
<span class="sd">           an iterator that yields the 2-tuple ``(name, value)``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">attributes_element</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;attribute&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                    <span class="s2">&quot;unexpected element: attributes/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">name</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                    <span class="s2">&quot;attribute/@name is required and cannot be empty&quot;</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unserialize_element_value</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="k">yield</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_unserialize_element_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">valuecontainer_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the appropriate object, value, Aglyph reference, or</span>
<span class="sd">        Aglyph evaluator for *element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element valuecontainer_element:</span>
<span class="sd">           an element with a single child element that describes a value</span>
<span class="sd">        :return:</span>
<span class="sd">           the runtime object that is the result of processing</span>
<span class="sd">           *valuecontainer_element*</span>
<span class="sd">        :rtype:</span>
<span class="sd">           an object of a Python built-in type, a Python built-in</span>
<span class="sd">           constant, a :class:`Reference`, or an :class:`Evaluator`</span>

<span class="sd">        *valuecontainer_element* must be an ``&lt;arg&gt;``, ``&lt;attribute&gt;``,</span>
<span class="sd">        ``&lt;key&gt;``, or ``&lt;value&gt;`` element.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">component_id</span> <span class="o">=</span> <span class="n">valuecontainer_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reference&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">component_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ref</span><span class="p">(</span><span class="n">component_id</span><span class="p">)</span>

        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">valuecontainer_element</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">vtag</span> <span class="o">=</span> <span class="n">valuecontainer_element</span><span class="o">.</span><span class="n">tag</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                <span class="s2">&quot;&lt;</span><span class="si">%s</span><span class="s2">&gt; must contain exactly one child element; found </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">vtag</span><span class="p">,</span>
                    <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">vtag</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">children</span> <span class="k">else</span> <span class="s2">&quot;no children&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_element</span><span class="p">(</span>
            <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">valuecontainer_element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_process_value_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_element</span><span class="p">,</span> <span class="n">parent_tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a usable Python object from *value_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element value_element:</span>
<span class="sd">           an element that describes a value</span>
<span class="sd">        :arg str parent_tag:</span>
<span class="sd">           the name of the *value_element* parent element</span>
<span class="sd">        :return:</span>
<span class="sd">           a Python object that is the value of *value_element*</span>

<span class="sd">        *value_element* must be a ``&lt;False /&gt;``, ``&lt;True /&gt;``,</span>
<span class="sd">        ``&lt;None /&gt;``, ``&lt;bytes&gt;``, ``&lt;str&gt;``, ``&lt;unicode&gt;``, ``&lt;int&gt;``,</span>
<span class="sd">        ``&lt;float&gt;``, ``&lt;tuple&gt;``, ``&lt;list&gt;``, ``&lt;dict&gt;``, or ``&lt;set&gt;``</span>
<span class="sd">        element.</span>

<span class="sd">        This method will return one of the following types, dependent</span>
<span class="sd">        upon the element:</span>

<span class="sd">        * an object of a Python built-in type</span>
<span class="sd">        * a Python built-in constant</span>
<span class="sd">        * an Aglyph :class:`Reference`</span>
<span class="sd">        * an Aglyph :class:`Evaluator`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parse_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_parse_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value_element</span><span class="o">.</span><span class="n">tag</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">parse_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                <span class="s2">&quot;unexpected element: </span><span class="si">%s</span><span class="s2">/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_tag</span><span class="p">,</span> <span class="n">value_element</span><span class="o">.</span><span class="n">tag</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">parse_value</span><span class="p">(</span><span class="n">value_element</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_False</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">false_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the builtin constant ``False``.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element false_element:</span>
<span class="sd">           a ``&lt;False /&gt;`` element</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_parse_True</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">true_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the builtin constant ``True``.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element true_element:</span>
<span class="sd">           a ``&lt;True /&gt;`` element</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_parse_None</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">none_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the builtin constant ``None``.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element none_element:</span>
<span class="sd">           a ``&lt;None /&gt;`` element</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_parse_bytes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bytes_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an encoded bytes object parsed from *bytes_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element bytes_element:</span>
<span class="sd">           a ``&lt;bytes&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :obj:`bytes` (Python 3) or :obj:`str` (Python 2)</span>

<span class="sd">        If the **bytes/@encoding** attribute is set, the text of the</span>
<span class="sd">        ``&lt;bytes&gt;`` element is encoded using the specified character</span>
<span class="sd">        set; otherwise, the text of the ``&lt;bytes&gt;`` element is encoded</span>
<span class="sd">        using :attr:`default_encoding`.</span>

<span class="sd">        Whitespace in the ``&lt;bytes&gt;`` element content is preserved.</span>

<span class="sd">        If *bytes_element* represents the empty element ``&lt;bytes /&gt;``,</span>
<span class="sd">        ``bytes()`` (Python 3) or ``str()`` (Python 2) is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bytes_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">bytes_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_encoding</span><span class="p">)</span>
            <span class="c1"># .encode() will return the appropriate type</span>
            <span class="k">return</span> <span class="n">bytes_element</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">DataType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__parse_str_as_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an encoded bytes object parsed from *str_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element str_element:</span>
<span class="sd">           a ``&lt;str&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :obj:`str` (Python 2)</span>

<span class="sd">        .. note::</span>
<span class="sd">           This method is aliased as ``_parse_str`` when Aglyph is</span>
<span class="sd">           running under Python 2.</span>

<span class="sd">        If the **str/@encoding** attribute has been set, the text of the</span>
<span class="sd">        ``&lt;str&gt;`` element is encoded using the specified character set;</span>
<span class="sd">        otherwise, the text of the ``&lt;str&gt;`` element is encoded using</span>
<span class="sd">        :attr:`default_encoding`.</span>

<span class="sd">        Whitespace in the ``&lt;str&gt;`` element content is preserved.</span>

<span class="sd">        If *str_element* represents the empty element ``&lt;str /&gt;``,</span>
<span class="sd">        ``str()`` is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">str_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">str_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_encoding</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">str_element</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__parse_str_as_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">str_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Unicode text object parsed from *str_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element str_element:</span>
<span class="sd">           a ``&lt;str&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :obj:`str` (Python 3)</span>

<span class="sd">        .. note::</span>
<span class="sd">           This method is aliased as ``_parse_str`` when Aglyph is</span>
<span class="sd">           running under Python 3.</span>

<span class="sd">        The text of the ``&lt;str&gt;`` element (which is already a Unicode</span>
<span class="sd">        string) is returned unchanged.</span>

<span class="sd">        Whitespace in the ``&lt;str&gt;`` element content is preserved.</span>

<span class="sd">        If *str_element* represents the empty element ``&lt;str /&gt;``,</span>
<span class="sd">        ``str()`` is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">str_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">encoding</span> <span class="o">=</span> <span class="n">str_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;encoding&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;ignoring str/@encoding attribute </span><span class="si">%r</span><span class="s2"> (Python 3)&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">str_element</span><span class="o">.</span><span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unicode_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a Unicode text object parsed from *unicode_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element unicode_element:</span>
<span class="sd">           a ``&lt;unicode&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :obj:`str` (Python 3) or :obj:`unicode` (Python 2)</span>

<span class="sd">        The text of the ``&lt;unicode&gt;`` element (which is already a</span>
<span class="sd">        Unicode string) is returned unchanged.</span>

<span class="sd">        Whitespace in the ``&lt;unicode&gt;`` element content is preserved.</span>

<span class="sd">        If *unicode_element* represents the empty element</span>
<span class="sd">        ``&lt;unicode /&gt;``, ``str()`` (Python 3) or ``unicode()``</span>
<span class="sd">        (Python 2) is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">unicode_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">unicode_element</span><span class="o">.</span><span class="n">text</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TextType</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">int_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a builtin integer object parsed from *int_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element int_element:</span>
<span class="sd">           an ``&lt;int&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :obj:`int`</span>

<span class="sd">        The **int/@base** attribute, if specified, is used as the number</span>
<span class="sd">        base to interpret the content of *int_element*.</span>

<span class="sd">        If *int_element* represents the empty element ``&lt;int /&gt;``,</span>
<span class="sd">        ``int()`` is returned.</span>

<span class="sd">        .. warning::</span>
<span class="sd">           This method **may** return :obj:`long` in Python 2!</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">int_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">base</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_element</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;10&quot;</span><span class="p">))</span>
            <span class="c1">#PYVER: IronPython 2.7 does not accept a &#39;base=&#39; keyword argument</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">int_element</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">base</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">float_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a builtin floating-point object parsed from</span>
<span class="sd">        *float_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element float_element:</span>
<span class="sd">           a ``&lt;float&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :obj:`float`</span>

<span class="sd">        If *float_element* represents the empty element ``&lt;float /&gt;``,</span>
<span class="sd">        ``float()`` is returned.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">float_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">float_element</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :obj:`list` evaluator object parsed from</span>
<span class="sd">        *list_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element list_element:</span>
<span class="sd">           a ``&lt;list&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`aglyph.component.Evaluator`</span>

<span class="sd">        .. note::</span>
<span class="sd">           The evaluator returned by this method produces a new</span>
<span class="sd">           :obj:`list` object each time it is called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_value_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_element</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">process_value_element</span><span class="p">(</span><span class="n">child_element</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child_element</span> <span class="ow">in</span> <span class="n">list_element</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">evaluate</span><span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tuple_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :obj:`tuple` evaluator object parsed from</span>
<span class="sd">        *tuple_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element tuple_element:</span>
<span class="sd">           a ``&lt;tuple&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`aglyph.component.Evaluator` (or :obj:`tuple` if</span>
<span class="sd">           the ``&lt;tuple&gt;`` element is empty)</span>

<span class="sd">        .. note::</span>
<span class="sd">           The evaluator returned by this method produces a new</span>
<span class="sd">           :obj:`tuple` object each time it is called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tuple_element</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">children</span><span class="p">:</span>
            <span class="n">process_value_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_element</span>
            <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">process_value_element</span><span class="p">(</span><span class="n">child_element</span><span class="p">,</span> <span class="s2">&quot;tuple&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child_element</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">evaluate</span><span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># a tuple is immutable, so there&#39;s no sense in paying the overhead</span>
            <span class="c1"># of evaluation for an empty tuple</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_parse_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">set_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :obj:`set` evaluator object parsed from</span>
<span class="sd">        *set_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element set_element:</span>
<span class="sd">           a ``&lt;set&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`aglyph.component.Evaluator`</span>

<span class="sd">        .. note::</span>
<span class="sd">           The evaluator returned by this method produces a new</span>
<span class="sd">           :obj:`set` object each time it is called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">process_value_element</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_value_element</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">process_value_element</span><span class="p">(</span><span class="n">child_element</span><span class="p">,</span> <span class="s2">&quot;set&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child_element</span> <span class="ow">in</span> <span class="n">set_element</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">evaluate</span><span class="p">(</span><span class="nb">set</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dict_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :obj:`dict` evaluator object parsed from</span>
<span class="sd">        *dict_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element dict_element:</span>
<span class="sd">           a ``&lt;dict&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           :class:`aglyph.component.Evaluator`</span>

<span class="sd">        .. note::</span>
<span class="sd">           The evaluator returned by this method produces a new</span>
<span class="sd">           :obj:`dict` object each time it is called.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># a list of 2-tuples, (key, value), used to initialize a dictionary</span>
        <span class="n">items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">dict_element</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span> <span class="o">!=</span> <span class="s2">&quot;item&quot;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span><span class="s2">&quot;unexpected element: dict/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">tag</span><span class="p">)</span>

            <span class="n">children</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="n">child_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">child</span><span class="o">.</span><span class="n">tag</span> <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">child_tags</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">]:</span>
                <span class="n">key_element</span><span class="p">,</span> <span class="n">value_element</span> <span class="o">=</span> <span class="n">children</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span>
                    <span class="s2">&quot;expected item/key, item/value; found </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;item/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">ctag</span> <span class="k">for</span> <span class="n">ctag</span> <span class="ow">in</span> <span class="n">child_tags</span><span class="p">))</span>

            <span class="n">items</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unserialize_element_value</span><span class="p">(</span><span class="n">key_element</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_unserialize_element_value</span><span class="p">(</span><span class="n">value_element</span><span class="p">)</span>
            <span class="p">))</span>

        <span class="k">return</span> <span class="n">evaluate</span><span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a reference to another component in this context.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element reference_element:</span>
<span class="sd">           a ``&lt;reference&gt;`` element</span>
<span class="sd">        :rtype:</span>
<span class="sd">           an Aglyph :class:`Reference`</span>

<span class="sd">        The **reference/@id** attribute is required, and will be used as</span>
<span class="sd">        the value to create an :class:`aglyph.component.Reference`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">component_id</span> <span class="o">=</span> <span class="n">reference_element</span><span class="o">.</span><span class="n">attrib</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ref</span><span class="p">(</span><span class="n">component_id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_parse_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eval_element</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a partial object that will evaluate an expression</span>
<span class="sd">        parsed from *eval_element*.</span>

<span class="sd">        :arg xml.etree.ElementTree.Element eval_element:\</span>
<span class="sd">           an ``&lt;eval&gt;`` element</span>
<span class="sd">        :rtype: :obj:`functools.partial`</span>

<span class="sd">        ..versionadded:: 3.0.0</span>
<span class="sd">           The partial object will use Python&#39;s :func:`ast.literal_eval`</span>
<span class="sd">           function to evaluate the expression when it is called. (Prior</span>
<span class="sd">           versions of Aglyph used the builtin :obj:`eval` function.)</span>

<span class="sd">        .. seealso::</span>
<span class="sd">           `Eval really is dangerous</span>
<span class="sd">           &lt;http://nedbatchelder.com/blog/201206/eval_really_is_dangerous.html&gt;`_</span>
<span class="sd">              Ned Batchelder&#39;s insanely thorough discussion of :obj:`eval`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">eval_element</span><span class="o">.</span><span class="n">text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">AglyphError</span><span class="p">(</span><span class="s2">&quot;&lt;eval&gt; cannot be an empty element&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">literal_eval</span><span class="p">,</span> <span class="n">eval_element</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__repr</span></div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Aglyph</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whats new in release 3.0.0.post1?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../get-started.html">Getting started with Aglyph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cookbook.html">Aglyph cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api-ref.html">Aglyph API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../context-fluent-api.html">The Aglyph Context fluent API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../testing.html">Aglyph 3.0.0.post1 testing summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap for future releases</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../aglyph.html">aglyph</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2006, 2011, 2013-2018 Matthew Zipay.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.8</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
    </div>

    

    
  </body>
</html>