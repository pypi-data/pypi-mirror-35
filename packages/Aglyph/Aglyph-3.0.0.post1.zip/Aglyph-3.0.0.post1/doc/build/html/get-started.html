
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Getting started with Aglyph &#8212; Aglyph 3.0.0.post1 documentation</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Aglyph cookbook" href="cookbook.html" />
    <link rel="prev" title="What’s new in release 1.1.0?" href="whats-new-1_1_0.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="getting-started-with-aglyph">
<h1>Getting started with Aglyph<a class="headerlink" href="#getting-started-with-aglyph" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Release:</th><td class="field-body">3.0.0.post1</td>
</tr>
</tbody>
</table>
<p>During this brief tutorial, you will download and install Aglyph, build a
simple Python application based on the <em>MovieLister</em> component discussed in
<a class="reference external" href="https://martinfowler.com/articles/injection.html">Inversion of Control Containers and the Dependency Injection pattern</a>,
then modify the application to take advantage of Aglyph dependency injection.
This process will allow you understand the Dependency Injection pattern in
general, and the Aglyph approach to Dependency Injection in particular.</p>
<p>This tutorial is a “whirlwind tour” of Aglyph that covers only the basics. Once
you have completed the steps, read the <a class="reference internal" href="cookbook.html"><span class="doc">Aglyph cookbook</span></a> for additional
guidelines and examples. Also review the <a class="reference internal" href="api-ref.html"><span class="doc">Aglyph API reference</span></a>, <a class="reference internal" href="context-fluent-api.html"><span class="doc">The Aglyph Context fluent API</span></a>
and the <a class="reference download internal" href="_downloads/aglyph-context.dtd" download=""><code class="xref download docutils literal notranslate"><span class="pre">Aglyph</span> <span class="pre">context</span> <span class="pre">DTD</span></code></a> to
understand the details.</p>
<p>The tutorial assumes that you are familiar with Python development in general,
and that Python 2.7 or 3.4+ is already installed on your system.</p>
<ul class="simple">
<li><a class="reference external" href="https://www.python.org/downloads/">Download Python</a></li>
<li>Browse <a class="reference external" href="http://www.diveintopython.net/">Dive Into Python 2</a> and/or <a class="reference external" href="https://docs.python.org/2/tutorial/index.html">The Python 2 Tutorial</a></li>
<li>Browse <a class="reference external" href="http://www.diveintopython3.net/">Dive Into Python 3</a> and/or <a class="reference external" href="https://docs.python.org/3/tutorial/index.html">The Python 3 Tutorial</a></li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is recommended, but not required, that you read the <a class="reference external" href="https://martinfowler.com/articles/injection.html">Inversion of
Control Containers and the Dependency Injection pattern</a> and
<a class="reference external" href="http://www.aleax.it/yt_pydi.pdf">Python Dependency Injection [PDF]</a> articles before beginning this tutorial.</p>
</div>
<div class="section" id="download-and-install-aglyph">
<span id="download-and-install"></span><h2>1. Download and install Aglyph<a class="headerlink" href="#download-and-install-aglyph" title="Permalink to this headline">¶</a></h2>
<p>There are several options for downloading and installing Aglyph. Choose the
method that best suits your needs or preferences.</p>
<div class="section" id="download-and-install-a-source-or-built-distribution-from-sourceforge">
<h3>Download and install a source or built distribution from SourceForge<a class="headerlink" href="#download-and-install-a-source-or-built-distribution-from-sourceforge" title="Permalink to this headline">¶</a></h3>
<p>If you use Windows, a source ZIP distribution and EXE and MSI installers are
available from the <a class="reference external" href="https://sourceforge.net/projects/aglyph/files/">Aglyph SourceForge project</a>.</p>
<p>Run the EXE or MSI installer after downloading, or unpack the ZIP distribution
and run the following command from within the distribution directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
</div>
<div class="section" id="download-and-install-a-source-distribution-from-the-python-package-index-pypi">
<h3>Download and install a source distribution from the Python Package Index (PyPI)<a class="headerlink" href="#download-and-install-a-source-distribution-from-the-python-package-index-pypi" title="Permalink to this headline">¶</a></h3>
<p>The Aglyph source distribution can be downloaded from the <a class="reference external" href="https://pypi.python.org/pypi/Aglyph">Aglyph PyPI page</a>.</p>
<p>Unpack the archive and run the following command from with the distribution
directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
</div>
<div class="section" id="clone-the-aglyph-repository-from-github">
<h3>Clone the Aglyph repository from GitHub<a class="headerlink" href="#clone-the-aglyph-repository-from-github" title="Permalink to this headline">¶</a></h3>
<p>To install the latest release from a clone of the <a class="reference external" href="https://github.com/mzipay/Aglyph">Aglyph GitHub repository</a>,
execute the following commands from a shell:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">mzipay</span><span class="o">/</span><span class="n">Aglyph</span><span class="o">.</span><span class="n">git</span>
<span class="n">cd</span> <span class="n">Aglyph</span>
<span class="n">python</span> <span class="n">setup</span><span class="o">.</span><span class="n">py</span> <span class="n">install</span>
</pre></div>
</div>
</div>
<div class="section" id="install-into-a-virtual-environment">
<h3>Install into a virtual environment<a class="headerlink" href="#install-into-a-virtual-environment" title="Permalink to this headline">¶</a></h3>
<p>You can also create a <a class="reference external" href="https://virtualenv.pypa.io/">Virtualenv</a> (details not covered here) and install
Aglyph into it by running the following commands from a shell (assumes the
virtual environment is active):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">Aglyph</span>
</pre></div>
</div>
<p>Regardless of installation method, verify that the installation was successful
by importing the <a class="reference internal" href="aglyph.html#module-aglyph" title="aglyph"><code class="xref py py-mod docutils literal notranslate"><span class="pre">aglyph</span></code></a> module from a Python interpreter. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python
Python 3.5.4 (default, Oct  9 2017, 12:07:29)
[GCC 6.4.1 20170727 (Red Hat 6.4.1-1)] on linux
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; import aglyph
&gt;&gt;&gt; aglyph.__version__
&#39;3.0.0.post1&#39;
</pre></div>
</div>
</div>
</div>
<div class="section" id="download-extract-and-run-the-movielisterapp-application">
<h2>2. Download, extract, and run the <em>movielisterapp</em> application<a class="headerlink" href="#download-extract-and-run-the-movielisterapp-application" title="Permalink to this headline">¶</a></h2>
<p>The sample code for this tutorial can be downloaded
<a class="reference download internal" href="_downloads/movielisterapp-basic.zip" download=""><code class="xref download docutils literal notranslate"><span class="pre">here</span> <span class="pre">(movielisterapp-basic.zip)</span></code></a>. If you don’t feel like typing
everything out by hand and would prefer to just “follow along,” you can also
download <a class="reference download internal" href="_downloads/movielisterapp-aglyph.zip" download=""><code class="xref download docutils literal notranslate"><span class="pre">movielisterapp-aglyph.zip</span></code></a>, which contains the completed
tutorial source code (including the already-populated SQLite database).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Both ZIP files are also available under the <em>examples/</em> directory if you
cloned the <a class="reference external" href="https://github.com/mzipay/Aglyph">Aglyph GitHub repository</a>.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Jython users will not be able to run the tutorial code because the standard
Python <a class="reference external" href="https://docs.python.org/3/library/sqlite3.html#module-sqlite3" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sqlite3</span></code></a> module (which Jython does not support) is used by the
example code.</p>
</div>
<p>To begin the tutorial, extract the ZIP archive to a temporary location and
navigate into the application directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ unzip movielisterapp-basic.zip
...
$ cd movielisterapp-basic
</pre></div>
</div>
<p>The <em>movies.txt</em> file is a simple colon-delimited text file that contains a
number of <em>title:director</em> records, one per line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">Colossus</span> <span class="n">of</span> <span class="n">Rhodes</span><span class="p">:</span><span class="n">Sergio</span> <span class="n">Leone</span>
<span class="n">Once</span> <span class="n">Upon</span> <span class="n">a</span> <span class="n">Time</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">West</span><span class="p">:</span><span class="n">Sergio</span> <span class="n">Leone</span>
<span class="n">THX</span> <span class="mi">1138</span><span class="p">:</span><span class="n">George</span> <span class="n">Lucas</span>
<span class="n">American</span> <span class="n">Graffiti</span><span class="p">:</span><span class="n">George</span> <span class="n">Lucas</span>
<span class="n">Once</span> <span class="n">Upon</span> <span class="n">a</span> <span class="n">Time</span> <span class="ow">in</span> <span class="n">America</span><span class="p">:</span><span class="n">Sergio</span> <span class="n">Leone</span>
<span class="n">Sixteen</span> <span class="n">Candles</span><span class="p">:</span><span class="n">John</span> <span class="n">Hughes</span>
<span class="n">The</span> <span class="n">Breakfast</span> <span class="n">Club</span><span class="p">:</span><span class="n">John</span> <span class="n">Hughes</span>
<span class="n">Weird</span> <span class="n">Science</span><span class="p">:</span><span class="n">John</span> <span class="n">Hughes</span>
<span class="n">Ferris</span> <span class="n">Bueller</span><span class="s1">&#39;s Day Off:John Hughes</span>
</pre></div>
</div>
<p>This data file is read by a particular implementation of the <code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code>
class (<code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code>), both of which can be found in the
<em>movies/finder.py</em> module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">movies.movie</span> <span class="k">import</span> <span class="n">Movie</span>


<span class="k">class</span> <span class="nc">MovieFinder</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ColonDelimitedMovieFinder</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">movies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_movies</span> <span class="o">=</span> <span class="n">movies</span>

    <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_movies</span>
</pre></div>
</div>
<p>As you can see, each record is processed as a simple <code class="docutils literal notranslate"><span class="pre">Movie</span></code> data holder
object. The <em>movies/movie.py</em> module holds the <code class="docutils literal notranslate"><span class="pre">Movie</span></code> class definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Movie</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">title</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">director</span> <span class="o">=</span> <span class="n">director</span>
</pre></div>
</div>
<p>Finally, we have a <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> class (defined in the <em>movies/lister.py</em>
module), which uses a <code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code> to find the movies directed
by a particular director:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">movies.finder</span> <span class="k">import</span> <span class="n">ColonDelimitedMovieFinder</span>


<span class="k">class</span> <span class="nc">MovieLister</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finder</span> <span class="o">=</span> <span class="n">ColonDelimitedMovieFinder</span><span class="p">(</span><span class="s2">&quot;movies.txt&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">movies_directed_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">director</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finder</span><span class="o">.</span><span class="n">find_all</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">director</span> <span class="o">==</span> <span class="n">director</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">movie</span>
</pre></div>
</div>
<p>The application can be executed using the <em>app.py</em> script, which simply asks
a <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> for all movies directed by Sergio Leone:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python app.py
The Colossus of Rhodes
Once Upon a Time in the West
Once Upon a Time in America
</pre></div>
</div>
</div>
<div class="section" id="a-very-brief-introduction-to-dependency-injection">
<span id="intro-to-di"></span><h2>3. A <em>(very)</em> brief introduction to Dependency Injection<a class="headerlink" href="#a-very-brief-introduction-to-dependency-injection" title="Permalink to this headline">¶</a></h2>
<p>Examine the <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> class (in the <em>movies/lister.py</em> module) again.
There are three things to note:</p>
<ol class="arabic simple">
<li>The <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> class depends on a concrete implementation of
<code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code>.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code> class depends on a filename.</li>
<li>The <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> is responsible for resolving <em>both</em> dependencies.</li>
</ol>
<p>As a consequence of (3), neither the concrete <code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code> implementation
nor the name/location of the data file can be changed without modifying
<code class="docutils literal notranslate"><span class="pre">MovieLister</span></code>.</p>
<p>In other words, it is <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> that controls dependency
resolution. It is this aspect of control that is being inverted (“Inversion of
Control”) when we talk about <strong>Dependency Injection</strong>. Rather than having
<code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> be responsible for <em>resolving</em> its dependencies, we instead
give control to some other object (an “assembler”), which has the
responsibility of <em>injecting</em> dependencies into <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code>.</p>
<p>The dependency injection approach provides several benefits:</p>
<ul class="simple">
<li>easier testing (“mock” or “stub” objects for testing are easier to manage)</li>
<li>lower general maintenance cost (e.g. the manner in which application/domain
objects get initialized and connected to one another is “homogenized” in the
assembler’s configuration, which makes application-wide changes easier to
apply and test)</li>
<li>the separation of object <em>configuration</em> from object <em>use</em> means generally
smaller and simpler application code that is focused on object behavior</li>
</ul>
<p>Aglyph can inject dependencies using initializers – <code class="docutils literal notranslate"><span class="pre">__init__</span></code> methods – or
“factory” functions (type 2 “constructor” injection); or member variables,
setter methods, and properties (type 3 “setter” injection).</p>
<p>In order to take advantage of type 2 “constructor” injection, the <code class="docutils literal notranslate"><span class="pre">__init__</span></code>
method or “factory” function must <em>accept</em> dependencies, which means we need
to make some simple changes to <em>movielisterapp</em>…</p>
</div>
<div class="section" id="make-some-general-improvements-to-the-movielisterapp-application">
<span id="app-changes-to-support-di"></span><h2>4. Make some general improvements to the <em>movielisterapp</em> application<a class="headerlink" href="#make-some-general-improvements-to-the-movielisterapp-application" title="Permalink to this headline">¶</a></h2>
<p>As written, the basic application is somewhat change-resistant. For example, if
we wish to support another implementation of <code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code> (e.g. one that
connects to a database to retrieve movie information), then we would also need
to change the <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> implementation.</p>
<p>A simple solution to this problem is to change <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> so that it can
<em>accept</em> a <code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code> at initialization time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MovieLister</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finder</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finder</span> <span class="o">=</span> <span class="n">finder</span>

    <span class="k">def</span> <span class="nf">movies_directed_by</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">director</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_finder</span><span class="o">.</span><span class="n">find_all</span><span class="p">():</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">movie</span><span class="o">.</span><span class="n">director</span> <span class="o">==</span> <span class="n">director</span><span class="p">):</span>
                <span class="k">yield</span> <span class="n">movie</span>
</pre></div>
</div>
<p>Next, we’ll add a <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code> class definition to the
<em>movies/finder.py</em> module. This new implementation will use the standard
Python <a class="reference external" href="https://docs.python.org/3/library/sqlite3.html#module-sqlite3" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sqlite3</span></code></a> module to connect to a SQLite database which stores the
movies information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">from</span> <span class="nn">movies.movie</span> <span class="k">import</span> <span class="n">Movie</span>


<span class="k">class</span> <span class="nc">MovieFinder</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ColonDelimitedMovieFinder</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
            <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">)</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
            <span class="n">movies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">))</span>
        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_movies</span> <span class="o">=</span> <span class="n">movies</span>

    <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_movies</span>


<span class="k">class</span> <span class="nc">SQLMovieFinder</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbname</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_db</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">find_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
        <span class="n">movies</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;select title, director from Movies&quot;</span><span class="p">):</span>
                <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">)</span> <span class="o">=</span> <span class="n">row</span>
                <span class="n">movies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Movie</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">director</span><span class="p">))</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">movies</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code> expects a database name (a filename, or <em>“:memory:”</em>
for an in-memory database). We’ll create a <em>movies.db</em> file so that it contains
the same records as the original <em>movies.txt</em> file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;movies.db&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;create table Movies (title text, director text)&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">movie_fields</span> <span class="ow">in</span> <span class="p">[(</span><span class="s2">&quot;The Colossus of Rhodes&quot;</span><span class="p">,</span> <span class="s2">&quot;Sergio Leone&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;Once Upon a Time in the West&quot;</span><span class="p">,</span> <span class="s2">&quot;Sergio Leone&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;THX 1138&quot;</span><span class="p">,</span> <span class="s2">&quot;George Lucas&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;American Graffiti&quot;</span><span class="p">,</span> <span class="s2">&quot;George Lucas&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;Once Upon a Time in America&quot;</span><span class="p">,</span> <span class="s2">&quot;Sergio Leone&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;Sixteen Candles&quot;</span><span class="p">,</span> <span class="s2">&quot;John Hughes&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;The Breakfast Club&quot;</span><span class="p">,</span> <span class="s2">&quot;John Hughes&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;Weird Science&quot;</span><span class="p">,</span> <span class="s2">&quot;John Hughes&quot;</span><span class="p">),</span>
<span class="gp">... </span>                     <span class="p">(</span><span class="s2">&quot;Ferris Bueller&#39;s Day Off&quot;</span><span class="p">,</span> <span class="s2">&quot;John Hughes&quot;</span><span class="p">)]:</span>
<span class="gp">&gt;&gt;&gt; </span>    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;insert into Movies values (?, ?)&quot;</span><span class="p">,</span> <span class="n">movie_fields</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>Finally, we’ll change <em>app.py</em> so that the new <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code> is used to
initialize a <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">movies.finder</span> <span class="k">import</span> <span class="n">SQLMovieFinder</span>
<span class="kn">from</span> <span class="nn">movies.lister</span> <span class="k">import</span> <span class="n">MovieLister</span>

<span class="n">lister</span> <span class="o">=</span> <span class="n">MovieLister</span><span class="p">(</span><span class="n">SQLMovieFinder</span><span class="p">(</span><span class="s2">&quot;movies.db&quot;</span><span class="p">))</span>
<span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">lister</span><span class="o">.</span><span class="n">movies_directed_by</span><span class="p">(</span><span class="s2">&quot;Sergio Leone&quot;</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">movie</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
<p>Running the application again should give us the same results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python app.py
The Colossus of Rhodes
Once Upon a Time in the West
Once Upon a Time in America
</pre></div>
</div>
<p>The basic application is now more flexible: we can change the <code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code>
implementation without having to modify the <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> class definition.
However, we are still required to modify <em>app.py</em> if we decide to change the
<code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code> implementation!</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>An important aspect of Aglyph is that it is <strong>non-intrusive</strong>, meaning that
it requires only minimal changes to your existing application code in order
to provide dependency injection capabilities.</p>
<p class="last">Notice that the changes made in this section, while adding flexibility to
the application, did not require the use of Aglyph. In fact, as we add
Aglyph dependency injection support in the next two sections, <strong>no further
changes</strong> to the <em>movies/lister.py</em>, <em>movies/finder.py</em>, and
<em>movies/movie.py</em> modules need to be made.</p>
</div>
</div>
<div class="section" id="add-dependency-injection-support-to-the-movielisterapp-application">
<h2>5. Add Dependency Injection support to the <em>movielisterapp</em> application<a class="headerlink" href="#add-dependency-injection-support-to-the-movielisterapp-application" title="Permalink to this headline">¶</a></h2>
<p>Recall that Dependency Injection gives reponsibility for injecting dependencies
to an an external object (called an “assembler”). In Aglyph, this “assembler”
is an instance of the <a class="reference internal" href="aglyph.assembler.html#aglyph.assembler.Assembler" title="aglyph.assembler.Assembler"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.assembler.Assembler</span></code></a> class.</p>
<p>An <a class="reference internal" href="aglyph.assembler.html#aglyph.assembler.Assembler" title="aglyph.assembler.Assembler"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.assembler.Assembler</span></code></a> requires a “context,” which is a
collection of component definitions. A <em>component</em>
(<a class="reference internal" href="aglyph.component.html#aglyph.component.Component" title="aglyph.component.Component"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.component.Component</span></code></a>) is simply a description of some object,
including how it is created/acquired and its dependencies. Any component can
itself be a dependency of any other component(s).</p>
<p>In Aglyph, a context is defined by the <a class="reference internal" href="aglyph.context.html#aglyph.context.Context" title="aglyph.context.Context"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.context.Context</span></code></a> class.
Objects of this class can be created and populated either directly or by using
<a class="reference internal" href="context-fluent-api.html"><span class="doc">The Aglyph Context fluent API</span></a>. A specialized subclass,
<a class="reference internal" href="aglyph.context.html#aglyph.context.XMLContext" title="aglyph.context.XMLContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.context.XMLContext</span></code></a>, is also provided to allow a context to be
defined declaratively in an XML document. Such XML documents should conform to
the <a class="reference download internal" href="_downloads/aglyph-context.dtd" download=""><code class="xref download docutils literal notranslate"><span class="pre">Aglyph</span> <span class="pre">context</span> <span class="pre">DTD</span></code></a>.</p>
<p>In this section, we will create a declarative XML context <strong>and</strong> use
<a class="reference internal" href="context-fluent-api.html"><span class="doc">The Aglyph Context fluent API</span></a> for <em>movielisterapp</em> in order to demonstrate each
approach.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">In practice, you should choose <strong>either</strong> <a class="reference internal" href="aglyph.context.html#aglyph.context.XMLContext" title="aglyph.context.XMLContext"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.context.XMLContext</span></code></a>
or <a class="reference internal" href="aglyph.context.html#aglyph.context.Context" title="aglyph.context.Context"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.context.Context</span></code></a> (<a class="reference internal" href="context-fluent-api.html"><span class="doc">The Aglyph Context fluent API</span></a>) when
configuring Aglyph for your application.</p>
</div>
<p>First, we’ll create the XML context document as <em>movies-context.xml</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;context id=&quot;movies-context&quot;&gt;
    &lt;component id=&quot;delim-finder&quot;
               dotted-name=&quot;movies.finder.ColonDelimitedMovieFinder&quot;&gt;
        &lt;init&gt;
            &lt;arg&gt;&lt;str&gt;movies.txt&lt;/str&gt;&lt;/arg&gt;
        &lt;/init&gt;
    &lt;/component&gt;
    &lt;component id=&quot;movies.finder.MovieFinder&quot;
               dotted-name=&quot;movies.finder.SQLMovieFinder&quot;&gt;
        &lt;init&gt;
            &lt;arg&gt;&lt;str&gt;movies.db&lt;/str&gt;&lt;/arg&gt;
        &lt;/init&gt;
    &lt;/component&gt;
    &lt;component id=&quot;movies.lister.MovieLister&quot;&gt;
        &lt;init&gt;
            &lt;arg reference=&quot;movies.finder.MovieFinder&quot; /&gt;
        &lt;/init&gt;
    &lt;/component&gt;
&lt;/context&gt;
</pre></div>
</div>
<p>Some interesting things to note here:</p>
<ul class="simple">
<li>A <code class="docutils literal notranslate"><span class="pre">&lt;context&gt;</span></code> requires an <code class="docutils literal notranslate"><span class="pre">id</span></code> attribute, which should uniquely identify
the context.</li>
<li>A <code class="docutils literal notranslate"><span class="pre">&lt;component&gt;</span></code> requires an <code class="docutils literal notranslate"><span class="pre">id</span></code> attribute, and has an optional
<code class="docutils literal notranslate"><span class="pre">dotted-name</span></code> attribute. If <code class="docutils literal notranslate"><span class="pre">dotted-name</span></code> is not provided, then the
<code class="docutils literal notranslate"><span class="pre">id</span></code> attribute is assumed to be a dotted name; otherwise, the <code class="docutils literal notranslate"><span class="pre">id</span></code> can
be a user-defined identifier and the <code class="docutils literal notranslate"><span class="pre">dotted-name</span></code> <strong>must</strong> be provided
(this is useful when describing multiple components of the same class, for
example). A dotted name is a string that represents an <strong>importable</strong> module,
class, or function.</li>
<li>Initialization arguments are provided as <code class="docutils literal notranslate"><span class="pre">&lt;arg&gt;</span></code> child elements of a parent
<code class="docutils literal notranslate"><span class="pre">&lt;init&gt;</span></code> element. An <code class="docutils literal notranslate"><span class="pre">&lt;arg&gt;</span></code> is a postional argument, while an
<code class="docutils literal notranslate"><span class="pre">&lt;arg</span> <span class="pre">keyword=&quot;...&quot;&gt;</span></code> is a keyword argument. (As in Python, the order in
which positional arguments are declared is significant, while the order of
keyword arguments is not.)</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>A dotted name is a <em>“dotted_name.NAME”</em> or <em>“dotted_name”</em> string that
represents a valid absolute import statement according to the following
productions:</p>
<pre>
<strong id="grammar-token-absolute_import_stmt">absolute_import_stmt</strong> ::=  &quot;from&quot; dotted_name &quot;import&quot; NAME
                          | &quot;import&quot; dotted_name
<strong id="grammar-token-dotted_name">dotted_name         </strong> ::=  NAME ('.' NAME)*
</pre>
<div class="last admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="https://docs.python.org/3/reference/grammar.html">Full Grammar specification</a></p>
</div>
</div>
<p>Notice that the <em>movies.lister.MovieLister</em> component is being injected with a
reference to the <em>movies.finder.MovieFinder</em> component, which describes an
instance of <code class="docutils literal notranslate"><span class="pre">movies.finder.SQLMovieFinder</span></code>. We could easily change back to
using <code class="docutils literal notranslate"><span class="pre">movies.finder.ColonDelimitedMovieFinder</span></code> by changing the reference.</p>
<p>Next, we’ll create an equivalent context, but this time using
<a class="reference internal" href="context-fluent-api.html"><span class="doc">The Aglyph Context fluent API</span></a>. In <em>movies/__init__.py</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">movies.finder</span> <span class="k">import</span> <span class="n">MovieFinder</span><span class="p">,</span> <span class="n">SQLMovieFinder</span>
<span class="kn">from</span> <span class="nn">movies.lister</span> <span class="k">import</span> <span class="n">MovieLister</span>

<span class="kn">from</span> <span class="nn">aglyph.component</span> <span class="k">import</span> <span class="n">Reference</span> <span class="k">as</span> <span class="n">ref</span>
<span class="kn">from</span> <span class="nn">aglyph.context</span> <span class="k">import</span> <span class="n">Context</span>


<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;movies-context&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="s2">&quot;delim-finder&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">create</span><span class="p">(</span><span class="s2">&quot;movies.finder.ColonDelimitedMovieFinder&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">init</span><span class="p">(</span><span class="s2">&quot;movies.txt&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">register</span><span class="p">())</span>

<span class="c1"># makes SQLMovieFinder the default impl bound to &quot;movies.finder.MovieFinder&quot;</span>
<span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">)</span><span class="o">.</span>
    <span class="n">create</span><span class="p">(</span><span class="n">SQLMovieFinder</span><span class="p">)</span><span class="o">.</span>
    <span class="n">init</span><span class="p">(</span><span class="s2">&quot;movies.db&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">register</span><span class="p">())</span>

<span class="c1"># will initialize MovieLister with an object of SQLMovieFinder</span>
<span class="n">context</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">MovieLister</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">ref</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">))</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
</pre></div>
</div>
<p>Compare this context carefully with the XML declarative context above; they
are identical. However, there are several interesting things to note about
initializing the context using the fluent API:</p>
<ul class="simple">
<li>Here we simply use the <code class="docutils literal notranslate"><span class="pre">component(...)</span></code> method, which results in all components
being of the default type (prototype). Defining components of different types
(i.e. prototype, singleton, borg, weakref) is simply a matter of using the
corresponding method name. We’ll use some of these in the next part of the tutorial.
These methods are the “entry points” into the fluent configuration API.</li>
<li>Each component definition is terminated by a call to the <code class="docutils literal notranslate"><span class="pre">register()</span></code>
method. This method <strong>must</strong> be the final call, as it (a) terminates the
chained-call sequence and, more importantly, (b) finalizes the compoonent
definition in the context. (If you get “component not found” errors when
using the fluent API, the first thing to check is that you remembered to
call <code class="docutils literal notranslate"><span class="pre">register()</span></code>!)</li>
<li>The component methods (<code class="docutils literal notranslate"><span class="pre">prototype(...)</span></code> / <code class="docutils literal notranslate"><span class="pre">singleton(...)</span></code> / <code class="docutils literal notranslate"><span class="pre">borg(...)</span></code>
/ <code class="docutils literal notranslate"><span class="pre">weakref(...)</span></code>) and the <code class="docutils literal notranslate"><span class="pre">create(...)</span></code> method can accept dotted-name strings
<em>as well as</em> objects. If the argument is <strong>not</strong> a string, Aglyph determines
its dotted-name and uses that value.
So in the above context, for example, <code class="docutils literal notranslate"><span class="pre">create(SQLMovieFinder)</span></code> is actually
equivalent to <code class="docutils literal notranslate"><span class="pre">create(&quot;movies.finder.SQLMovieFinder&quot;)</span></code>.</li>
<li>Unlike the component and create methods, the <code class="docutils literal notranslate"><span class="pre">init(...)</span></code> and <code class="docutils literal notranslate"><span class="pre">set(...)</span></code>
(not shown here) methods do <strong>not</strong> automatically convert non-string arguments
to dotted names. This is so that classes and other callables may be used
directly as arguments. This is why we must use <code class="docutils literal notranslate"><span class="pre">init(ref(MovieFinder))</span></code>
(note the use of <code class="docutils literal notranslate"><span class="pre">ref(...)</span></code>) when defining the MovieLister component.</li>
</ul>
<p>Now that we have created Aglyph configurations for <em>movielisterapp</em>, it’s time
to modify the <em>app.py</em> script to use dependency injection. To demonstrate the
use of both types of configution, we’ll create two different versions of the
application script.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">As noted earlier, in practice you would choose <strong>one</strong> of the configuration
options and set up your application entry point appropriately.</p>
</div>
<p>The <em>app_xml.py</em> script will use the declarative XML context:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">aglyph.assembler</span> <span class="k">import</span> <span class="n">Assembler</span>
<span class="kn">from</span> <span class="nn">aglyph.context</span> <span class="k">import</span> <span class="n">XMLContext</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">XMLContext</span><span class="p">(</span><span class="s2">&quot;movies-context.xml&quot;</span><span class="p">)</span>
<span class="n">assembler</span> <span class="o">=</span> <span class="n">Assembler</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="n">lister</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="s2">&quot;movies.lister.MovieLister&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">lister</span><span class="o">.</span><span class="n">movies_directed_by</span><span class="p">(</span><span class="s2">&quot;Sergio Leone&quot;</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">movie</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
<p>This script creates an assembler with a context that is read from the
<em>movies-context.xml</em> XML document. Notice that we no longer need to create the
<code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code> class directly; we have effectively separated the
configuration of <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> from its use in the application.</p>
<p>Running the application produces the same results as usual:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python app_xml.py
The Colossus of Rhodes
Once Upon a Time in the West
Once Upon a Time in America
</pre></div>
</div>
<p>The <em>app_fluent.py</em> script will use the context that was created in
<em>movies/__init__.py</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">aglyph.assembler</span> <span class="k">import</span> <span class="n">Assembler</span>
<span class="kn">from</span> <span class="nn">movies</span> <span class="k">import</span> <span class="n">context</span>

<span class="n">assembler</span> <span class="o">=</span> <span class="n">Assembler</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

<span class="n">lister</span> <span class="o">=</span> <span class="n">assembler</span><span class="o">.</span><span class="n">assemble</span><span class="p">(</span><span class="s2">&quot;movies.lister.MovieLister&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">movie</span> <span class="ow">in</span> <span class="n">lister</span><span class="o">.</span><span class="n">movies_directed_by</span><span class="p">(</span><span class="s2">&quot;Sergio Leone&quot;</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">movie</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</pre></div>
</div>
<p>Again, running the application produces the expected results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ python app_fluent.py
The Colossus of Rhodes
Once Upon a Time in the West
Once Upon a Time in America
</pre></div>
</div>
</div>
<div class="section" id="make-changes-to-the-movielisterapp-application">
<h2>6. Make changes to the <em>movielisterapp</em> application<a class="headerlink" href="#make-changes-to-the-movielisterapp-application" title="Permalink to this headline">¶</a></h2>
<p>Now that the application is configured to use Aglyph for dependency injection,
let’s make some changes to demonstrate application maintenance under Aglyph.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The key point of this final exercise is that we will be able to make
“significant” changes to the application without having to modify any of the
application source code.
This is possible because we have <em>separated the configuration of objects
from their use</em>; this is the goal of Depdendency Injection.</p>
</div>
<div class="section" id="introducing-assembly-strategies">
<h3>Introducing assembly strategies<a class="headerlink" href="#introducing-assembly-strategies" title="Permalink to this headline">¶</a></h3>
<p>In our existing configurations, all components are using Aglyph’s default
assembly strategy, <strong>prototype</strong>, which means that each time a component is
assembled, a new object is created, initialized, wired, and returned.</p>
<p>This is not always desired (or appropriate), so Aglyph also supports
<strong>singleton</strong>, <strong>borg</strong>, and <strong>weakref</strong> assembly strategies.</p>
<p>For details of what each assembly strategy implies, please refer to
<a class="reference internal" href="aglyph.component.html#aglyph.component.Strategy" title="aglyph.component.Strategy"><code class="xref py py-obj docutils literal notranslate"><span class="pre">aglyph.component.Strategy</span></code></a>.</p>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<dl class="last docutils">
<dt><a class="reference external" href="http://code.activestate.com/recipes/66531-singleton-we-dont-need-no-stinkin-singleton-the-bo/">The Borg design pattern</a></dt>
<dd>Alex Martelli’s original Borg recipe (from ActiveState Python Recipes)</dd>
<dt>Module <a class="reference external" href="https://docs.python.org/3/library/weakref.html#module-weakref" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">weakref</span></code></a></dt>
<dd>Documentation of the <a class="reference external" href="https://docs.python.org/3/library/weakref.html#module-weakref" title="(in Python v3.7)"><code class="xref py py-mod docutils literal notranslate"><span class="pre">weakref</span></code></a> standard module.</dd>
</dl>
</div>
</div>
<div class="section" id="modify-movielisterapp-to-use-a-singleton-colondelimitedmoviefinder">
<h3>Modify <em>movielisterapp</em> to use a singleton <code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code><a class="headerlink" href="#modify-movielisterapp-to-use-a-singleton-colondelimitedmoviefinder" title="Permalink to this headline">¶</a></h3>
<p>We note that <code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code> class parses its data file on every
initialization. We don’t expect the data file to change very often, at least
not during application runtime, so we’d prefer to only create an instance of
<code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code> <em>once</em>, regardless of how many times during the
application runtime that it is requested (i.e. assembled). For the sake of
demonstration, preted for a moment that <em>movielisterapp</em> is a useful
application in which <code class="docutils literal notranslate"><span class="pre">MovieFinder</span></code> objects are used by more than just a
<code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> ;)</p>
<p>To accomplish this goal, we’ll modify our configurations so that the
<em>“delim-finder”</em> component uses the <strong>singleton</strong> assembly strategy.</p>
<p>Also, we’ll change the <em>movies.lister.MovieLister</em> component so that it uses
the original <code class="docutils literal notranslate"><span class="pre">ColonDelimitedMovieFinder</span></code> instead of <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code>.</p>
<p>The modified XML context looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;context id=&quot;movies-context&quot;&gt;
    &lt;component id=&quot;delim-finder&quot;
               dotted-name=&quot;movies.finder.ColonDelimitedMovieFinder&quot;
               strategy=&quot;singleton&quot;&gt;
        &lt;init&gt;
            &lt;arg&gt;&lt;str&gt;movies.txt&lt;/str&gt;&lt;/arg&gt;
        &lt;/init&gt;
    &lt;/component&gt;
    &lt;component id=&quot;movies.finder.MovieFinder&quot;
               dotted-name=&quot;movies.finder.SQLMovieFinder&quot;&gt;
        &lt;init&gt;
            &lt;arg&gt;&lt;str&gt;movies.db&lt;/str&gt;&lt;/arg&gt;
        &lt;/init&gt;
    &lt;/component&gt;
    &lt;component id=&quot;movies.lister.MovieLister&quot;&gt;
        &lt;init&gt;
            &lt;arg reference=&quot;delim-finder&quot; /&gt;
        &lt;/init&gt;
    &lt;/component&gt;
&lt;/context&gt;
</pre></div>
</div>
<p>We added <code class="docutils literal notranslate"><span class="pre">strategy=&quot;singleton&quot;</span></code> to the <em>“delim-finder”</em> component, and
changed the <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> argument to specify <code class="docutils literal notranslate"><span class="pre">reference=&quot;delim-finder&quot;</span></code>.</p>
<p>The modifed <em>movies/__init__.py</em> module looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">movies.finder</span> <span class="k">import</span> <span class="n">MovieFinder</span><span class="p">,</span> <span class="n">SQLMovieFinder</span>
<span class="kn">from</span> <span class="nn">movies.lister</span> <span class="k">import</span> <span class="n">MovieLister</span>

<span class="kn">from</span> <span class="nn">aglyph.component</span> <span class="k">import</span> <span class="n">Reference</span> <span class="k">as</span> <span class="n">ref</span>
<span class="kn">from</span> <span class="nn">aglyph.context</span> <span class="k">import</span> <span class="n">Context</span>


<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;movies-context&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">singleton</span><span class="p">(</span><span class="s2">&quot;delim-finder&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">create</span><span class="p">(</span><span class="s2">&quot;movies.finder.ColonDelimitedMovieFinder&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">init</span><span class="p">(</span><span class="s2">&quot;movies.txt&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">register</span><span class="p">())</span>

<span class="c1"># makes SQLMovieFinder the default impl bound to &quot;movies.finder.MovieFinder&quot;</span>
<span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">borg</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">)</span><span class="o">.</span>
    <span class="n">create</span><span class="p">(</span><span class="n">SQLMovieFinder</span><span class="p">)</span><span class="o">.</span>
    <span class="n">init</span><span class="p">(</span><span class="s2">&quot;movies.db&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">register</span><span class="p">())</span>

<span class="c1"># will initialize MovieLister with an object of ColonDelimitedMovieFinder</span>
<span class="n">context</span><span class="o">.</span><span class="n">component</span><span class="p">(</span><span class="n">MovieLister</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">ref</span><span class="p">(</span><span class="s2">&quot;delim-finder&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
</pre></div>
</div>
<p>We used the <code class="docutils literal notranslate"><span class="pre">singleton(...)</span></code> method to define the <em>“delim-finder”</em> component.
Also, because the component ID <em>“delim-finder”</em> is not a dotted name, we
need to manually specify that the <code class="docutils literal notranslate"><span class="pre">MovieLister</span></code> argument is an
<a class="reference internal" href="aglyph.component.html#aglyph.component.Reference" title="aglyph.component.Reference"><code class="xref py py-class docutils literal notranslate"><span class="pre">aglyph.component.Reference</span></code></a> to <em>“delim-finder”</em>.</p>
<p>Running either version of the application still produces the expected results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">Colossus</span> <span class="n">of</span> <span class="n">Rhodes</span>
<span class="n">Once</span> <span class="n">Upon</span> <span class="n">a</span> <span class="n">Time</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">West</span>
<span class="n">Once</span> <span class="n">Upon</span> <span class="n">a</span> <span class="n">Time</span> <span class="ow">in</span> <span class="n">America</span>
</pre></div>
</div>
</div>
<div class="section" id="modify-movielisterapp-again-to-use-a-borg-sqlmoviefinder">
<h3>Modify <em>movielisterapp</em> again to use a borg <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code><a class="headerlink" href="#modify-movielisterapp-again-to-use-a-borg-sqlmoviefinder" title="Permalink to this headline">¶</a></h3>
<p>We also note that <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code> doesn’t really need to create a new
database connection every time it is assembled. We <em>could</em> use the singleton
assembly strategy, but instead we’ll use a similar pattern called <strong>borg</strong>. Of
course, we’ll also change the application to again use the <code class="docutils literal notranslate"><span class="pre">SQLMovieFinder</span></code>.</p>
<p>The final modified XML context looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;context id=&quot;movies-context&quot;&gt;
    &lt;component id=&quot;delim-finder&quot;
               dotted-name=&quot;movies.finder.ColonDelimitedMovieFinder&quot;
               strategy=&quot;singleton&quot;&gt;
        &lt;init&gt;
            &lt;arg&gt;&lt;str&gt;movies.txt&lt;/str&gt;&lt;/arg&gt;
        &lt;/init&gt;
    &lt;/component&gt;
    &lt;component id=&quot;movies.finder.MovieFinder&quot;
               dotted-name=&quot;movies.finder.SQLMovieFinder&quot;
               strategy=&quot;borg&quot;&gt;
        &lt;init&gt;
            &lt;arg&gt;&lt;str&gt;movies.db&lt;/str&gt;&lt;/arg&gt;
        &lt;/init&gt;
    &lt;/component&gt;
    &lt;component id=&quot;movies.lister.MovieLister&quot;&gt;
        &lt;init&gt;
            &lt;arg reference=&quot;movies.finder.MovieFinder&quot; /&gt;
        &lt;/init&gt;
    &lt;/component&gt;
&lt;/context&gt;
</pre></div>
</div>
<p>The final modifed <em>movies/__init__.py</em> looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">movies.finder</span> <span class="k">import</span> <span class="n">MovieFinder</span><span class="p">,</span> <span class="n">SQLMovieFinder</span>
<span class="kn">from</span> <span class="nn">movies.lister</span> <span class="k">import</span> <span class="n">MovieLister</span>

<span class="kn">from</span> <span class="nn">aglyph.component</span> <span class="k">import</span> <span class="n">Reference</span> <span class="k">as</span> <span class="n">ref</span>
<span class="kn">from</span> <span class="nn">aglyph.context</span> <span class="k">import</span> <span class="n">Context</span>


<span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="s2">&quot;movies-context&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">singleton</span><span class="p">(</span><span class="s2">&quot;delim-finder&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">create</span><span class="p">(</span><span class="s2">&quot;movies.finder.ColonDelimitedMovieFinder&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">init</span><span class="p">(</span><span class="s2">&quot;movies.txt&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">register</span><span class="p">())</span>

<span class="c1"># makes SQLMovieFinder the default impl bound to &quot;movies.finder.MovieFinder&quot;</span>
<span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">borg</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">)</span><span class="o">.</span>
    <span class="n">create</span><span class="p">(</span><span class="n">SQLMovieFinder</span><span class="p">)</span><span class="o">.</span>
    <span class="n">init</span><span class="p">(</span><span class="s2">&quot;movies.db&quot;</span><span class="p">)</span><span class="o">.</span>
    <span class="n">register</span><span class="p">())</span>

<span class="c1"># will initialize MovieLister with an object of SQLMovieFinder</span>
<span class="n">context</span><span class="o">.</span><span class="n">prototype</span><span class="p">(</span><span class="n">MovieLister</span><span class="p">)</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">ref</span><span class="p">(</span><span class="n">MovieFinder</span><span class="p">))</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
</pre></div>
</div>
<p>Running either the <em>app_xml.py</em> or <em>app_fluent.py</em> version of the application
with the final configuration changes still produces the expected results:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">The</span> <span class="n">Colossus</span> <span class="n">of</span> <span class="n">Rhodes</span>
<span class="n">Once</span> <span class="n">Upon</span> <span class="n">a</span> <span class="n">Time</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">West</span>
<span class="n">Once</span> <span class="n">Upon</span> <span class="n">a</span> <span class="n">Time</span> <span class="ow">in</span> <span class="n">America</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="suggested-next-steps">
<h2>Suggested next steps<a class="headerlink" href="#suggested-next-steps" title="Permalink to this headline">¶</a></h2>
<p>There are many more context/configuration options available in Aglyph beyond
those that have been presented in this tutorial, including support for type 2
“setter” injection using member variables, setter methods, and properties
(which can also be combined with the type 3 “constructor” injection used in
the <em>movielisterapp</em> sample application).</p>
<p>Suggested next steps:</p>
<ol class="arabic simple">
<li>Read the <a class="reference internal" href="cookbook.html"><span class="doc">Aglyph cookbook</span></a>.</li>
<li>Read the <a class="reference internal" href="api-ref.html"><span class="doc">Aglyph API reference</span></a> and <a class="reference internal" href="context-fluent-api.html"><span class="doc">The Aglyph Context fluent API</span></a>.</li>
<li>Read the <a class="reference download internal" href="_downloads/aglyph-context.dtd" download=""><code class="xref download docutils literal notranslate"><span class="pre">Aglyph</span> <span class="pre">context</span> <span class="pre">DTD</span></code></a>. The DTD is fully commented, and
explains some of the finer points of using XML configuration.</li>
<li>Examine the Aglyph test cases (part of the distribution; located in the
<em>tests/</em> directory).</li>
<li>Start with either the <a class="reference download internal" href="_downloads/movielisterapp-basic.zip" download=""><code class="xref download docutils literal notranslate"><span class="pre">movielisterapp-basic</span></code></a> or
<a class="reference download internal" href="_downloads/movielisterapp-aglyph.zip" download=""><code class="xref download docutils literal notranslate"><span class="pre">movielisterapp-aglyph</span></code></a> applications and make your own
modifications to explore the features of Aglyph.</li>
</ol>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Aglyph</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="whats-new.html">What’s new in release 3.0.0.post1?</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Getting started with Aglyph</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#download-and-install-aglyph">1. Download and install Aglyph</a></li>
<li class="toctree-l2"><a class="reference internal" href="#download-extract-and-run-the-movielisterapp-application">2. Download, extract, and run the <em>movielisterapp</em> application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#a-very-brief-introduction-to-dependency-injection">3. A <em>(very)</em> brief introduction to Dependency Injection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-some-general-improvements-to-the-movielisterapp-application">4. Make some general improvements to the <em>movielisterapp</em> application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#add-dependency-injection-support-to-the-movielisterapp-application">5. Add Dependency Injection support to the <em>movielisterapp</em> application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-changes-to-the-movielisterapp-application">6. Make changes to the <em>movielisterapp</em> application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#suggested-next-steps">Suggested next steps</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="cookbook.html">Aglyph cookbook</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-ref.html">Aglyph API reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="context-fluent-api.html">The Aglyph Context fluent API</a></li>
<li class="toctree-l1"><a class="reference internal" href="testing.html">Aglyph 3.0.0.post1 testing summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap for future releases</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="whats-new-1_1_0.html" title="previous chapter">What’s new in release 1.1.0?</a></li>
      <li>Next: <a href="cookbook.html" title="next chapter">Aglyph cookbook</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2006, 2011, 2013-2018 Matthew Zipay.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.7.8</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
      |
      <a href="_sources/get-started.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>