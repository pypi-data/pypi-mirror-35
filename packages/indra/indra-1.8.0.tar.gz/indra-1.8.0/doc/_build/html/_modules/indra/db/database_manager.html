

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>indra.db.database_manager &mdash; INDRA 1.8.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../search.html"/>
    <link rel="top" title="INDRA 1.8.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> INDRA
          

          
          </a>

          
            
            
              <div class="version">
                1.8
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">License and funding</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting started with INDRA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">INDRA modules reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../rest_api.html">REST API</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">INDRA</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>indra.db.database_manager</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for indra.db.database_manager</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span> <span class="n">unicode_literals</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="k">import</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">str</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sqltypes&#39;</span><span class="p">,</span> <span class="s1">&#39;texttypes&#39;</span><span class="p">,</span> <span class="s1">&#39;formats&#39;</span><span class="p">,</span> <span class="s1">&#39;DatabaseManager&#39;</span><span class="p">,</span>
           <span class="s1">&#39;IndraDatabaseError&#39;</span><span class="p">,</span> <span class="s1">&#39;sql_expressions&#39;</span><span class="p">]</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">io</span> <span class="k">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span> <span class="nn">numbers</span> <span class="k">import</span> <span class="n">Number</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">expression</span> <span class="k">as</span> <span class="n">sql_expressions</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="k">import</span> <span class="n">DropTable</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">Delete</span><span class="p">,</span> <span class="n">Update</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="k">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">UniqueConstraint</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> \
    <span class="n">create_engine</span><span class="p">,</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">LargeBinary</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">BigInteger</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.attributes</span> <span class="k">import</span> <span class="n">InstrumentedAttribute</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.dialects.postgresql</span> <span class="k">import</span> <span class="n">BYTEA</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
    <span class="n">WITH_NX</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">WITH_NX</span> <span class="o">=</span> <span class="kc">False</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;db_manager&#39;</span><span class="p">)</span>


<span class="c1"># Solution to fix postgres drop tables</span>
<span class="c1"># See: https://stackoverflow.com/questions/38678336/sqlalchemy-how-to-implement-drop-table-cascade</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">DropTable</span><span class="p">,</span> <span class="s2">&quot;postgresql&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">_compile_drop_table</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_drop_table</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; CASCADE&quot;</span>


<span class="c1"># Solution to fix deletes with constraints from multiple tables.</span>
<span class="c1"># See: https://groups.google.com/forum/#!topic/sqlalchemy/cIvgH2y01_o</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">Delete</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_delete</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_delete</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
    <span class="n">extra_froms</span> <span class="o">=</span> <span class="n">Update</span><span class="o">.</span><span class="n">_extra_froms</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extra_froms</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
                    <span class="sa">r</span><span class="s2">&quot;(FROM \S+)&quot;</span><span class="p">,</span>
                    <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> USING </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                        <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">asfrom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">fr</span> <span class="ow">in</span> <span class="n">extra_froms</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">text</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pgcopy</span> <span class="k">import</span> <span class="n">CopyManager</span>
    <span class="n">CAN_COPY</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: pgcopy unavailable. Bulk copies will be slow.&quot;</span><span class="p">)</span>
    <span class="n">CopyManager</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">CAN_COPY</span> <span class="o">=</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_isiterable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="s2">&quot;Bool determines if an object is an iterable (not a string)&quot;</span>
    <span class="k">return</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__iter__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_map_class</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_getattrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span>
            <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">items</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattrs</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattrs</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">keys</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_getattrs</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">sqltypes</span><span class="p">(</span><span class="n">_map_class</span><span class="p">):</span>
    <span class="n">POSTGRESQL</span> <span class="o">=</span> <span class="s1">&#39;postgresql&#39;</span>
    <span class="n">SQLITE</span> <span class="o">=</span> <span class="s1">&#39;sqlite&#39;</span>


<span class="k">class</span> <span class="nc">texttypes</span><span class="p">(</span><span class="n">_map_class</span><span class="p">):</span>
    <span class="n">FULLTEXT</span> <span class="o">=</span> <span class="s1">&#39;fulltext&#39;</span>
    <span class="n">ABSTRACT</span> <span class="o">=</span> <span class="s1">&#39;abstract&#39;</span>


<span class="k">class</span> <span class="nc">formats</span><span class="p">(</span><span class="n">_map_class</span><span class="p">):</span>
    <span class="n">XML</span> <span class="o">=</span> <span class="s1">&#39;xml&#39;</span>
    <span class="n">TEXT</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
    <span class="n">JSON</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>


<div class="viewcode-block" id="IndraDatabaseError"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.IndraDatabaseError">[docs]</a><span class="k">class</span> <span class="nc">IndraDatabaseError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span></div>
    <span class="k">pass</span>


<div class="viewcode-block" id="DatabaseManager"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager">[docs]</a><span class="k">class</span> <span class="nc">DatabaseManager</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;An object used to access INDRA&#39;s database.</span>

<span class="sd">    This object can be used to access and manage indra&#39;s database. It includes</span>
<span class="sd">    both basic methods and some useful, more high-level methods. It is designed</span>
<span class="sd">    to be used with postgresql, or sqlite.</span>

<span class="sd">    This object is primarily built around sqlalchemy, which is a required</span>
<span class="sd">    package for its use. It also optionally makes use of the pgcopy package for</span>
<span class="sd">    large data transfers.</span>

<span class="sd">    If you wish to access the primary database, you can simply use the</span>
<span class="sd">    `get_primary_db` to get an instance of this object using the default</span>
<span class="sd">    settings.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    host : str</span>
<span class="sd">        The database to which you want to interface.</span>
<span class="sd">    sqltype : OPTIONAL[str]</span>
<span class="sd">        The type of sql library used. Use one of the sql types provided by</span>
<span class="sd">        `sqltypes`. Default is `sqltypes.POSTGRESQL`</span>
<span class="sd">    label : OPTIONAL[str]</span>
<span class="sd">        A short string to indicate the purpose of the db instance. Set as</span>
<span class="sd">        primary when initialized be `get_primary_db`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    If you wish to acces the primary database and find the the metadata for a</span>
<span class="sd">    particular pmid, 1234567:</span>

<span class="sd">    &gt;&gt; from indra.db import get_primary_db()</span>
<span class="sd">    &gt;&gt; db = get_primary_db()</span>
<span class="sd">    &gt;&gt; res = db.select_all(db.TextRef, db.TextRef.pmid == &#39;1234567&#39;)</span>

<span class="sd">    You will get a list of objects whose attributes give the metadata contained</span>
<span class="sd">    in the columns of the table.</span>

<span class="sd">    For more sophisticated examples, several use cases can be found in</span>
<span class="sd">    `indra.tests.test_db`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">sqltype</span><span class="o">=</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">POSTGRESQL</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqltype</span> <span class="o">=</span> <span class="n">sqltype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">sqltype</span> <span class="ow">is</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">POSTGRESQL</span><span class="p">:</span>
            <span class="n">Bytea</span> <span class="o">=</span> <span class="n">BYTEA</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Bytea</span> <span class="o">=</span> <span class="n">LargeBinary</span>

        <span class="k">class</span> <span class="nc">TextRef</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;text_ref&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">pmid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
            <span class="n">pmcid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">))</span>
            <span class="n">doi</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span>
            <span class="n">pii</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Maybe longer?</span>
            <span class="n">manuscript_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">create_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;pmid&#39;</span><span class="p">,</span> <span class="s1">&#39;doi&#39;</span><span class="p">),</span>
                <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;pmcid&#39;</span><span class="p">,</span> <span class="s1">&#39;doi&#39;</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TextRef</span> <span class="o">=</span> <span class="n">TextRef</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">TextRef</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextRef</span>

        <span class="k">class</span> <span class="nc">SourceFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;source_file&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">load_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">SourceFile</span> <span class="o">=</span> <span class="n">SourceFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">SourceFile</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">SourceFile</span>

        <span class="k">class</span> <span class="nc">Updates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;updates&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">init_upload</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">unresolved_conflicts_file</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Bytea</span><span class="p">)</span>
            <span class="n">datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Updates</span> <span class="o">=</span> <span class="n">Updates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">Updates</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">Updates</span>

        <span class="k">class</span> <span class="nc">TextContent</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;text_content&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">text_ref_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span>
                                 <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;text_ref.id&#39;</span><span class="p">),</span>
                                 <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">text_ref</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">TextRef</span><span class="p">)</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">text_type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">content</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Bytea</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">insert_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">UniqueConstraint</span><span class="p">(</span>
                    <span class="s1">&#39;text_ref_id&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;text_type&#39;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TextContent</span> <span class="o">=</span> <span class="n">TextContent</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">TextContent</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">TextContent</span>

        <span class="k">class</span> <span class="nc">Reading</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;reading&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">text_content_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span>
                                     <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;text_content.id&#39;</span><span class="p">),</span>
                                     <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">text_content</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">TextContent</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">reader_version</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>  <span class="c1"># xml, json, etc.</span>
            <span class="nb">bytes</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Bytea</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">create_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">UniqueConstraint</span><span class="p">(</span>
                    <span class="s1">&#39;text_content_id&#39;</span><span class="p">,</span> <span class="s1">&#39;reader&#39;</span><span class="p">,</span> <span class="s1">&#39;reader_version&#39;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Reading</span> <span class="o">=</span> <span class="n">Reading</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">Reading</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">Reading</span>

        <span class="k">class</span> <span class="nc">ReadingUpdates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;reading_updates&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">complete_read</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">reader_version</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">run_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">earliest_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">)</span>
            <span class="n">latest_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ReadingUpdates</span> <span class="o">=</span> <span class="n">ReadingUpdates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">ReadingUpdates</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">ReadingUpdates</span>

        <span class="k">class</span> <span class="nc">DBInfo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;db_info&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">create_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="n">last_updated</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">DBInfo</span> <span class="o">=</span> <span class="n">DBInfo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">DBInfo</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">DBInfo</span>

        <span class="k">class</span> <span class="nc">RawStatements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;raw_statements&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">mk_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">db_info_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;db_info.id&#39;</span><span class="p">))</span>
            <span class="n">db_info</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">DBInfo</span><span class="p">)</span>
            <span class="n">reading_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;reading.id&#39;</span><span class="p">))</span>
            <span class="n">reading</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">Reading</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">indra_version</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Bytea</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">create_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RawStatements</span> <span class="o">=</span> <span class="n">RawStatements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">RawStatements</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">RawStatements</span>

        <span class="k">class</span> <span class="nc">RawAgents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;raw_agents&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">stmt_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span>
                             <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;raw_statements.id&#39;</span><span class="p">),</span>
                             <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">statements</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">RawStatements</span><span class="p">)</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">db_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RawAgents</span> <span class="o">=</span> <span class="n">RawAgents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">RawAgents</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">RawAgents</span>

        <span class="k">class</span> <span class="nc">RawUniqueLinks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;raw_unique_links&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">raw_stmt_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;raw_statements.id&#39;</span><span class="p">),</span>
                                 <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">pa_stmt_mk_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;pa_statements.mk_hash&#39;</span><span class="p">),</span>
                                     <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RawUniqueLinks</span> <span class="o">=</span> <span class="n">RawUniqueLinks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">RawUniqueLinks</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">RawUniqueLinks</span>

        <span class="k">class</span> <span class="nc">PreassemblyUpdates</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;preassembly_updates&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">corpus_init</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">run_datetime</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PreassemblyUpdates</span> <span class="o">=</span> <span class="n">PreassemblyUpdates</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">PreassemblyUpdates</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">PreassemblyUpdates</span>

        <span class="k">class</span> <span class="nc">PAStatements</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;pa_statements&#39;</span>
            <span class="n">mk_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">matches_key</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">uuid</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">indra_version</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">100</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">json</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Bytea</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">create_date</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAStatements</span> <span class="o">=</span> <span class="n">PAStatements</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">PAStatements</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAStatements</span>

        <span class="k">class</span> <span class="nc">PAAgents</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;pa_agents&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">stmt_mk_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span>
                                  <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;pa_statements.mk_hash&#39;</span><span class="p">),</span>
                                  <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">statements</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">PAStatements</span><span class="p">)</span>
            <span class="n">db_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">db_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PAAgents</span> <span class="o">=</span> <span class="n">PAAgents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">PAAgents</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAAgents</span>

        <span class="k">class</span> <span class="nc">PASupportLinks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">):</span>
            <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;pa_support_links&#39;</span>
            <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">supporting_mk_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span>
                                        <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;pa_statements.mk_hash&#39;</span><span class="p">),</span>
                                        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">supported_mk_hash</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">BigInteger</span><span class="p">,</span>
                                       <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;pa_statements.mk_hash&#39;</span><span class="p">),</span>
                                       <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">PASupportLinks</span> <span class="o">=</span> <span class="n">PASupportLinks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">PASupportLinks</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">]</span> <span class="o">=</span> <span class="n">PASupportLinks</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">host</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">WITH_NX</span><span class="p">:</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">Graph</span><span class="p">()</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_edges_from</span><span class="p">([</span>
                <span class="p">(</span><span class="s1">&#39;pa_agents&#39;</span><span class="p">,</span> <span class="s1">&#39;pa_statements&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;raw_unique_links&#39;</span><span class="p">,</span> <span class="s1">&#39;pa_statements&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;raw_unique_links&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_statements&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;raw_statements&#39;</span><span class="p">,</span> <span class="s1">&#39;reading&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;raw_agents&#39;</span><span class="p">,</span> <span class="s1">&#39;raw_statements&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;raw_statements&#39;</span><span class="p">,</span> <span class="s1">&#39;db_info&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;reading&#39;</span><span class="p">,</span> <span class="s1">&#39;text_content&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;text_content&#39;</span><span class="p">,</span> <span class="s1">&#39;text_ref&#39;</span><span class="p">)</span>
                <span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__foreign_key_graph</span> <span class="o">=</span> <span class="n">G</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__foreign_key_graph</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grab_session</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to execute rollback of database upon deletion.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseManager.create_tables"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.create_tables">[docs]</a>    <span class="k">def</span> <span class="nf">create_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Create the tables for INDRA database.&quot;</span>
        <span class="k">if</span> <span class="n">tbl_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating all tables...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created all tables.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">tbl_name_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">tbl_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">tbl_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl_name_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">)</span>
            <span class="c1"># These tables must be created in this order.</span>
            <span class="k">for</span> <span class="n">tbl_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;text_ref&#39;</span><span class="p">,</span> <span class="s1">&#39;text_content&#39;</span><span class="p">,</span> <span class="s1">&#39;readings&#39;</span><span class="p">,</span> <span class="s1">&#39;db_info&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;statements&#39;</span><span class="p">,</span> <span class="s1">&#39;agents&#39;</span><span class="p">,</span> <span class="s1">&#39;pa_statements&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;pa_agents&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">tbl_name</span> <span class="ow">in</span> <span class="n">tbl_name_list</span><span class="p">:</span>
                    <span class="n">tbl_name_list</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">tbl_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tbl_name</span><span class="p">]</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tbl_name</span><span class="p">]</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table created.&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table already existed.&quot;</span><span class="p">)</span>
            <span class="c1"># The rest can be started any time.</span>
            <span class="k">for</span> <span class="n">tbl_name</span> <span class="ow">in</span> <span class="n">tbl_name_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Creating </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">tbl_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tbl_name</span><span class="p">]</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table created.&quot;</span><span class="p">)</span></div>
        <span class="k">return</span>

<div class="viewcode-block" id="DatabaseManager.drop_tables"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.drop_tables">[docs]</a>    <span class="k">def</span> <span class="nf">drop_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drop the tables for INDRA database given in tbl_list.</span>

<span class="sd">        If tbl_list is None, all tables will be dropped. Note that if `force`</span>
<span class="sd">        is False, a warning prompt will be raised to asking for confirmation,</span>
<span class="sd">        as this action will remove all data from that table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">tbl_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tbl_objs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">tbl_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="n">tbl_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tbl</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tbl_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tbl</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="c1"># Build the message</span>
            <span class="k">if</span> <span class="n">tbl_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Do you really want to clear the </span><span class="si">%s</span><span class="s2"> database? [y/N]: &quot;</span>
                       <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;You are going to clear the following tables:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">([</span><span class="n">tbl</span><span class="o">.</span><span class="n">__tablename__</span> <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">tbl_objs</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span><span class="s2">&quot;Do you really want to clear these tables from </span><span class="si">%s</span><span class="s2">? &quot;</span>
                        <span class="s2">&quot;[y/N]: &quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">)</span>
            <span class="c1"># Check to make sure.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;y&#39;</span> <span class="ow">and</span> <span class="n">resp</span> <span class="o">!=</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Aborting clear.&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">tbl_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing all tables...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;All tables removed.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">tbl_list</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Removing </span><span class="si">%s</span><span class="s2">...&quot;</span> <span class="o">%</span> <span class="n">tbl</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">tbl</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">):</span>
                    <span class="n">tbl</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table removed.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Table doesn&#39;t exist.&quot;</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_clear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Brutal clearing of all tables in tbl_list, or all tables.&quot;</span>
        <span class="c1"># This is intended for testing purposes, not general use.</span>
        <span class="c1"># Use with care.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_session</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rolling back before clear...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Rolled back.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_tables</span><span class="p">(</span><span class="n">tbl_list</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="n">force</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_tables</span><span class="p">(</span><span class="n">tbl_list</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

<div class="viewcode-block" id="DatabaseManager.grab_session"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.grab_session">[docs]</a>    <span class="k">def</span> <span class="nf">grab_session</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get an active session with the database.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">is_active</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempting to get session...&#39;</span><span class="p">)</span>
            <span class="n">DBSession</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Got session.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></div>
                <span class="k">raise</span> <span class="n">IndraDatabaseError</span><span class="p">(</span><span class="s2">&quot;Failed to grab session.&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseManager.get_tables"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.get_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get a list of available tables.&quot;</span></div>
        <span class="k">return</span> <span class="p">[</span><span class="n">tbl_name</span> <span class="k">for</span> <span class="n">tbl_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>

<div class="viewcode-block" id="DatabaseManager.show_tables"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.show_tables">[docs]</a>    <span class="k">def</span> <span class="nf">show_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Print a list of all the available tables.&quot;</span></div>
        <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_tables</span><span class="p">())</span>

<div class="viewcode-block" id="DatabaseManager.get_active_tables"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.get_active_tables">[docs]</a>    <span class="k">def</span> <span class="nf">get_active_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Get the tables currently active in the database.&quot;</span></div>
        <span class="k">return</span> <span class="n">inspect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">get_table_names</span><span class="p">()</span>

<div class="viewcode-block" id="DatabaseManager.get_column_names"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.get_column_names">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_name</span><span class="p">):</span>
        <span class="s2">&quot;Get a list of the column labels for a table.&quot;</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_objects</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">)</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

<div class="viewcode-block" id="DatabaseManager.get_column_objects"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.get_column_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_column_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="s1">&#39;Get a list of the column object for the given table.&#39;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">)):</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span>

<div class="viewcode-block" id="DatabaseManager.commit"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.commit">[docs]</a>    <span class="k">def</span> <span class="nf">commit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">err_msg</span><span class="p">):</span>
        <span class="s2">&quot;Commit, and give useful info if there is an exception.&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Attempting to commit...&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Message committed.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Got exception in commit, rolling back...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Rolled back.&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">err_msg</span><span class="p">)</span></div>
            <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_get_foreign_key_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_name_1</span><span class="p">,</span> <span class="n">table_name_2</span><span class="p">):</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_name_1</span><span class="p">])</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">col</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
                <span class="n">target_table_name</span><span class="p">,</span> <span class="n">target_col</span> <span class="o">=</span> <span class="n">fk</span><span class="o">.</span><span class="n">target_fullname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">table_name_2</span> <span class="o">==</span> <span class="n">target_table_name</span><span class="p">:</span>
                    <span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">col</span> <span class="o">==</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table_name_2</span><span class="p">],</span>
                                          <span class="n">target_col</span><span class="p">))</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="DatabaseManager.join"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.join">[docs]</a>    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_1</span><span class="p">,</span> <span class="n">table_2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the joining clause between two tables, if one exists.</span>

<span class="sd">        If no link exists, an exception will be raised. Note that this only</span>
<span class="sd">        works for directly links.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table_name_1</span> <span class="o">=</span> <span class="n">table_1</span><span class="o">.</span><span class="n">__tablename__</span>
        <span class="n">table_name_2</span> <span class="o">=</span> <span class="n">table_2</span><span class="o">.</span><span class="n">__tablename__</span>
        <span class="k">if</span> <span class="n">WITH_NX</span><span class="p">:</span>
            <span class="n">fk_path</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">shortest_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__foreign_key_graph</span><span class="p">,</span> <span class="n">table_name_1</span><span class="p">,</span>
                                       <span class="n">table_name_2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fk_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">table_name_1</span><span class="p">,</span> <span class="n">table_name_2</span><span class="p">]</span>

        <span class="n">links</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fk_path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_foreign_key_constraint</span><span class="p">(</span><span class="n">fk_path</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fk_path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">link</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_foreign_key_constraint</span><span class="p">(</span><span class="n">fk_path</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span>
                                                        <span class="n">fk_path</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">link</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IndraDatabaseError</span><span class="p">(</span><span class="s2">&quot;There is no foreign key in </span><span class="si">%s</span><span class="s2"> &quot;</span>
                                         <span class="s2">&quot;pointing to </span><span class="si">%s</span><span class="s2">.&quot;</span>
                                         <span class="o">%</span> <span class="p">(</span><span class="n">table_name_1</span><span class="p">,</span> <span class="n">table_name_2</span><span class="p">))</span>
            <span class="n">links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="n">links</span>

<div class="viewcode-block" id="DatabaseManager.get_values"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.get_values">[docs]</a>    <span class="k">def</span> <span class="nf">get_values</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_list</span><span class="p">,</span> <span class="n">col_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keyed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="s2">&quot;Get the column values from the entries in entry_list&quot;</span>
        <span class="k">if</span> <span class="n">col_names</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># Get everything.</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">entry_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entry_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_isiterable</span><span class="p">(</span><span class="n">col_names</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">keyed</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="n">col</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">})</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ret</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">col_names</span><span class="p">))</span></div>
        <span class="k">return</span> <span class="n">ret</span>

<div class="viewcode-block" id="DatabaseManager.insert"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.insert">[docs]</a>    <span class="k">def</span> <span class="nf">insert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">ret_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">input_dict</span><span class="p">):</span>
        <span class="s2">&quot;Insert a an entry into specified table, and return id.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_session</span><span class="p">()</span>
        <span class="c1"># Resolve the table instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">))</span>

        <span class="c1"># Get the default return info</span>
        <span class="k">if</span> <span class="n">ret_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret_info</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Do the insert</span>
        <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
        <span class="n">new_entry</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="s2">&quot;Excepted while trying to insert </span><span class="si">%s</span><span class="s2"> into </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">))</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">([</span><span class="n">new_entry</span><span class="p">],</span> <span class="n">ret_info</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<div class="viewcode-block" id="DatabaseManager.insert_many"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.insert_many">[docs]</a>    <span class="k">def</span> <span class="nf">insert_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">input_data_list</span><span class="p">,</span> <span class="n">ret_info</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Insert many records into the table given by table_name.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_session</span><span class="p">()</span>

        <span class="c1"># Resolve the table instance</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">table</span><span class="p">))</span>
            <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">table</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">))</span>

        <span class="c1"># Set the default return info</span>
        <span class="k">if</span> <span class="n">ret_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ret_info</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">primary_key</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Prepare and insert the data</span>
        <span class="n">entry_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">input_data</span> <span class="ow">in</span> <span class="n">input_data_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
                <span class="n">input_dict</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">input_data</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">input_dict</span> <span class="o">=</span> <span class="n">input_data</span>
            <span class="n">inputs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
            <span class="n">entry_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">(</span><span class="o">**</span><span class="n">inputs</span><span class="p">))</span>
            <span class="n">inputs</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>  <span class="c1"># Clear the values of the dict.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">(</span><span class="n">entry_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="s2">&quot;Excepted while trying to insert:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">,</span><span class="se">\n</span><span class="s2">into </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">input_data_list</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">__tablename__</span><span class="p">))</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_values</span><span class="p">(</span><span class="n">entry_list</span><span class="p">,</span> <span class="n">ret_info</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseManager.delete_all"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.delete_all">[docs]</a>    <span class="k">def</span> <span class="nf">delete_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">entry_list</span><span class="p">):</span>
        <span class="s2">&quot;Remove the given records from the given table.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_session</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">entry_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="s2">&quot;Could not remove </span><span class="si">%d</span><span class="s2"> records from the database.&quot;</span> <span class="o">%</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">entry_list</span><span class="p">))</span></div>
        <span class="k">return</span>

<div class="viewcode-block" id="DatabaseManager.copy"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbl_name</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="s2">&quot;Use pg_copy to copy over a large amount of data.&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received request to copy </span><span class="si">%d</span><span class="s2"> entries into </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">tbl_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Nothing to do....</span>

        <span class="c1"># If cols is not specified, use all the cols in the table, else check</span>
        <span class="c1"># to make sure the names are valid.</span>
        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">db_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_names</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">([</span><span class="n">col</span> <span class="ow">in</span> <span class="n">db_cols</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">]),</span>\
                <span class="s2">&quot;Do not recognize one of the columns in </span><span class="si">%s</span><span class="s2"> for table </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">tbl_name</span><span class="p">)</span>

        <span class="c1"># Do the copy. Use pgcopy if available.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqltype</span> <span class="o">==</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">POSTGRESQL</span> <span class="ow">and</span> <span class="n">CAN_COPY</span><span class="p">:</span>
            <span class="c1"># Check for automatic timestamps which won&#39;t be applied by the</span>
            <span class="c1"># database when using copy, and manually insert them.</span>
            <span class="n">auto_timestamp_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_column_objects</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">default</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">auto_timestamp_type</span><span class="p">)</span> \
                       <span class="ow">and</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying timestamps to </span><span class="si">%s</span><span class="s2">.&quot;</span> <span class="o">%</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
                        <span class="n">cols</span> <span class="o">+=</span> <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">,)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">datum</span> <span class="o">+</span> <span class="p">(</span><span class="n">now</span><span class="p">,)</span> <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

            <span class="c1"># Now actually do the copy</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">raw_connection</span><span class="p">()</span>
            <span class="n">mngr</span> <span class="o">=</span> <span class="n">CopyManager</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">tbl_name</span><span class="p">,</span> <span class="n">cols</span><span class="p">)</span>
            <span class="n">data_bts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="n">new_entry</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">entry</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">new_entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)</span>
                          <span class="ow">or</span> <span class="n">element</span> <span class="ow">is</span> <span class="kc">None</span>
                          <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span>
                          <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
                        <span class="n">new_entry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">IndraDatabaseError</span><span class="p">(</span>
                            <span class="s2">&quot;Don&#39;t know what to do with element of type </span><span class="si">%s</span><span class="s2">.&quot;</span>
                            <span class="s2">&quot;Should be str, bytes, datetime, None, or a &quot;</span>
                            <span class="s2">&quot;number.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
                            <span class="p">)</span>
                <span class="n">data_bts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">new_entry</span><span class="p">))</span>
            <span class="n">mngr</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">data_bts</span><span class="p">,</span> <span class="n">BytesIO</span><span class="p">)</span>
            <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: use bulk insert mappings?</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;You are not using postgresql or do not have &quot;</span>
                           <span class="s2">&quot;pgcopy, so this will likely be very slow.&quot;</span><span class="p">)</span></div>
            <span class="bp">self</span><span class="o">.</span><span class="n">insert_many</span><span class="p">(</span><span class="n">tbl_name</span><span class="p">,</span> <span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">ro</span><span class="p">))</span> <span class="k">for</span> <span class="n">ro</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>

<div class="viewcode-block" id="DatabaseManager.filter_query"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.filter_query">[docs]</a>    <span class="k">def</span> <span class="nf">filter_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s2">&quot;Query a table and filter results.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grab_session</span><span class="p">()</span>
        <span class="n">ok_classes</span> <span class="o">=</span> <span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Base</span><span class="p">),</span> <span class="n">InstrumentedAttribute</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">_isiterable</span><span class="p">(</span><span class="n">tbls</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">ok_class</span><span class="p">)</span> <span class="k">for</span> <span class="n">ok_class</span> <span class="ow">in</span> <span class="n">ok_classes</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">tbls</span><span class="p">]):</span>
                <span class="n">query_args</span> <span class="o">=</span> <span class="n">tbls</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">query_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tbl</span><span class="p">]</span> <span class="k">for</span> <span class="n">tbl</span> <span class="ow">in</span> <span class="n">tbls</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IndraDatabaseError</span><span class="p">(</span>
                    <span class="s1">&#39;Unrecognized table specification type: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">tbls</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="n">ok_class</span><span class="p">)</span> <span class="k">for</span> <span class="n">ok_class</span> <span class="ow">in</span> <span class="n">ok_classes</span><span class="p">]):</span>
                <span class="n">query_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">tbls</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">query_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">tbls</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IndraDatabaseError</span><span class="p">(</span>
                    <span class="s1">&#39;Unrecognized table specification type: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                    <span class="nb">type</span><span class="p">(</span><span class="n">tbls</span><span class="p">)</span>
                    <span class="p">)</span>
</div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">query_args</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<div class="viewcode-block" id="DatabaseManager.count"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get a count of the results to a query.&quot;&quot;&quot;</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<div class="viewcode-block" id="DatabaseManager.select_one"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.select_one">[docs]</a>    <span class="k">def</span> <span class="nf">select_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select the first value that matches requirements.</span>

<span class="sd">        Requirements are given in kwargs from table indicated by tbl_name. See</span>
<span class="sd">        `select_all`.</span>

<span class="sd">        Note that if your specification yields multiple results, this method</span>
<span class="sd">        will just return the first result without exception.</span>
<span class="sd">        &quot;&quot;&quot;</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

<div class="viewcode-block" id="DatabaseManager.select_all"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.select_all">[docs]</a>    <span class="k">def</span> <span class="nf">select_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select any and all entries from table given by tbl_name.</span>

<span class="sd">        The results will be filtered by your keyword arguments. For example if</span>
<span class="sd">        you want to get a text ref with pmid &#39;10532205&#39;, you would call:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            db.select_all(&#39;text_ref&#39;, db.TextRef.pmid == &#39;10532205&#39;)</span>

<span class="sd">        Note that double equals are required, not a single equal. Equivalently</span>
<span class="sd">        you could call:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            db.select_all(db.TextRef, db.TextRef.pmid == &#39;10532205&#39;)</span>

<span class="sd">        For a more complicated example, suppose you want to get all text refs</span>
<span class="sd">        that have full text from pmc oa, you could select:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">           db.select_all(</span>
<span class="sd">               [db.TextRef, db.TextContent],</span>
<span class="sd">               db.TextContent.text_ref_id == db.TextRef.id,</span>
<span class="sd">               db.TextContent.source == &#39;pmc_oa&#39;,</span>
<span class="sd">               db.TextContent.text_type == &#39;fulltext&#39;</span>
<span class="sd">               )</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tbls, *args</span>
<span class="sd">            See above for usage.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            yield_per: int or None</span>
<span class="sd">            If the result to your query is expected to be large, you can choose</span>
<span class="sd">            to only load `yield_per` items at a time, using the eponymous</span>
<span class="sd">            feature of sqlalchemy queries. Default is None, meaning all results</span>
<span class="sd">            will be loaded simultaneously.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yield_per</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;yield_per&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yield_per</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">yield_per</span><span class="p">(</span><span class="n">yield_per</span><span class="p">)</span></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class="viewcode-block" id="DatabaseManager.select_sample_from_table"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.select_sample_from_table">[docs]</a>    <span class="k">def</span> <span class="nf">select_sample_from_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Select a number of random samples from the given table.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        number : int</span>
<span class="sd">            The number of samples to return</span>
<span class="sd">        table : str, table class, or column attribute of table class</span>
<span class="sd">            The table or table column to be sampled.</span>
<span class="sd">        *args, **kwargs :</span>
<span class="sd">            All other arguments are passed to `select_all`, including any and</span>
<span class="sd">            all filtering clauses.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        A list of sqlalchemy orm objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the base set of tables needed.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">true_table</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;class_&#39;</span><span class="p">):</span>
            <span class="n">true_table</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">class_</span>
        <span class="k">elif</span> <span class="n">table</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">true_table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IndraDatabaseError</span><span class="p">(</span><span class="s2">&quot;Unrecognized table: </span><span class="si">%s</span><span class="s2"> of type </span><span class="si">%s</span><span class="s2">&quot;</span>
                                     <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">table</span><span class="p">)))</span>

        <span class="c1"># Get all ids for this table given query filters</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting all relevant ids.&quot;</span><span class="p">)</span>
        <span class="n">id_tuples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span><span class="n">true_table</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">({</span><span class="n">entry_id</span> <span class="k">for</span> <span class="n">entry_id</span><span class="p">,</span> <span class="ow">in</span> <span class="n">id_tuples</span><span class="p">})</span>

        <span class="c1"># Sample from the list of ids</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Getting sample.&quot;</span><span class="p">)</span>
        <span class="n">id_sample</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">id_list</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">table</span><span class="o">.</span><span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[(</span><span class="n">entry_id</span><span class="p">,)</span> <span class="k">for</span> <span class="n">entry_id</span> <span class="ow">in</span> <span class="n">id_sample</span><span class="p">]</span>
</div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_all</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">id_sample</span><span class="p">))</span>

<div class="viewcode-block" id="DatabaseManager.has_entry"><a class="viewcode-back" href="../../../modules/db/index.html#indra.db.database_manager.DatabaseManager.has_entry">[docs]</a>    <span class="k">def</span> <span class="nf">has_entry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="s2">&quot;Check whether an entry/entries matching given specs live in the db.&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_query</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div></div>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span><span class="o">.</span><span class="n">first</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, B. M. Gyori, J. A. Bachman.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.8.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>